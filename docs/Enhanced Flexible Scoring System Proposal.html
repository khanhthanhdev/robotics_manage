<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Enhanced Flexible Scoring System Proposal</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="enhanced-flexible-scoring-system-proposal">Enhanced Flexible Scoring System Proposal</h1>
<p>This document outlines a detailed proposal for implementing a flexible scoring system in the Robotics Tournament Management System, specifically designed to accommodate complex scoring rules like those in the fire-fighting competition while maintaining adaptability for future competition types.</p>
<h2 id="1-schema-design">1. Schema Design</h2>
<h3 id="11-new-prisma-schema-models">1.1 New Prisma Schema Models</h3>
<pre><code class="language-prisma">model ScoreConfig {
  id                String           @id @default(uuid())
  tournamentId      String
  tournament        Tournament       @relation(fields: [tournamentId], references: [id])
  name              String           // e.g., &quot;Fire Fighting Competition 2025&quot;
  description       String?
  scoreElements     ScoreElement[]
  bonusConditions   BonusCondition[]
  penaltyConditions PenaltyCondition[]
  matchScores       MatchScore[]     // Relation to match scores using this config
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
}

model ScoreElement {
  id            String      @id @default(uuid())
  scoreConfigId String
  scoreConfig   ScoreConfig @relation(fields: [scoreConfigId], references: [id], onDelete: Cascade)
  name          String      // e.g., &quot;Dry Powder in Own Area&quot;
  code          String      // Unique identifier for this element, e.g., &quot;dry_powder_own&quot;
  description   String?
  pointsPerUnit Int         // e.g., 5 (can be negative for penalties)
  maxUnits      Int?        // Optional limit (e.g., max 10 balls)
  category      String?     // For grouping related elements
  elementType   String      // &quot;counter&quot; (numeric) or &quot;boolean&quot; (yes/no)
  displayOrder  Int         // For UI ordering
  icon          String?     // Optional icon reference
  color         String?     // Optional color for UI
  
  @@unique([scoreConfigId, code])
}

model BonusCondition {
  id            String      @id @default(uuid())
  scoreConfigId String
  scoreConfig   ScoreConfig @relation(fields: [scoreConfigId], references: [id], onDelete: Cascade)
  name          String      // e.g., &quot;5 Dry Powder Balls Bonus&quot;
  code          String      // Unique identifier, e.g., &quot;five_balls_bonus&quot;
  description   String?
  bonusPoints   Int         // e.g., 10
  condition     Json        // JSON for storing condition logic
  displayOrder  Int         // For UI ordering
  
  @@unique([scoreConfigId, code])
}

model PenaltyCondition {
  id            String      @id @default(uuid())
  scoreConfigId String
  scoreConfig   ScoreConfig @relation(fields: [scoreConfigId], references: [id], onDelete: Cascade)
  name          String      // e.g., &quot;Red Area Violation&quot;
  code          String      // Unique identifier, e.g., &quot;red_area_violation&quot;
  description   String?
  penaltyPoints Int         // e.g., -10
  condition     Json        // JSON for storing condition logic
  displayOrder  Int         // For UI ordering
  
  @@unique([scoreConfigId, code])
}

model MatchScore {
  id                String      @id @default(uuid())
  matchId           String
  match             Match       @relation(fields: [matchId], references: [id])
  allianceId        String
  alliance          Alliance    @relation(fields: [allianceId], references: [id])
  scoreConfigId     String
  scoreConfig       ScoreConfig @relation(fields: [scoreConfigId], references: [id])
  elementScores     Json        // Store counts for each ScoreElement
  bonusesEarned     String[]    // IDs of earned BonusCondition
  penaltiesIncurred String[]    // IDs of incurred PenaltyCondition
  calculationLog    Json?       // Optional detailed breakdown of score calculation
  totalScore        Int         // Calculated total
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@unique([matchId, allianceId])
}
</code></pre>
<h3 id="12-condition-json-structure">1.2 Condition JSON Structure</h3>
<p>For the <code>condition</code> field in <code>BonusCondition</code> and <code>PenaltyCondition</code>, we'll use a structured JSON format:</p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;threshold&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;elementCode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;dry_powder_own&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;operator&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&gt;=&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Or for more complex conditions:</p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;composite&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;operator&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;AND&quot;</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;conditions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;threshold&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;elementCode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;dry_powder_own&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;operator&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&gt;=&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;threshold&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;elementCode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;red_area_balls&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;operator&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&gt;&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 id="2-backend-implementation-nestjs">2. Backend Implementation (NestJS)</h2>
<h3 id="21-module-structure">2.1 Module Structure</h3>
<pre><code>src/
├── score-config/
│   ├── score-config.module.ts
│   ├── score-config.controller.ts
│   ├── score-config.service.ts
│   ├── dto/
│   │   ├── create-score-config.dto.ts
│   │   ├── update-score-config.dto.ts
│   │   ├── create-score-element.dto.ts
│   │   ├── create-bonus-condition.dto.ts
│   │   └── create-penalty-condition.dto.ts
│   └── entities/
│       ├── score-config.entity.ts
│       ├── score-element.entity.ts
│       ├── bonus-condition.entity.ts
│       └── penalty-condition.entity.ts
├── match-score/
│   ├── match-score.module.ts
│   ├── match-score.controller.ts
│   ├── match-score.service.ts
│   ├── dto/
│   │   ├── submit-score.dto.ts
│   │   └── score-calculation-result.dto.ts
│   └── entities/
│       └── match-score.entity.ts
└── score-calculation/
    ├── score-calculation.module.ts
    ├── score-calculation.service.ts
    ├── interfaces/
    │   ├── condition.interface.ts
    │   └── score-element-value.interface.ts
    └── strategies/
        ├── condition-evaluator.strategy.ts
        ├── threshold-condition.strategy.ts
        └── composite-condition.strategy.ts
</code></pre>
<h3 id="22-service-layer-design">2.2 Service Layer Design</h3>
<p>Following SOLID principles, we'll implement:</p>
<h4 id="scoreconfigservice">ScoreConfigService</h4>
<pre><code class="language-typescript"><span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScoreConfigService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> prisma: PrismaService</span>) {}

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">createScoreConfig</span>(<span class="hljs-attr">data</span>: <span class="hljs-title class_">CreateScoreConfigDto</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ScoreConfig</span>&gt; {
    <span class="hljs-keyword">const</span> { scoreElements, bonusConditions, penaltyConditions, ...configData } = data;
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.$transaction(<span class="hljs-keyword">async</span> (prisma) =&gt; {
      <span class="hljs-comment">// Create the score config</span>
      <span class="hljs-keyword">const</span> scoreConfig = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">scoreConfig</span>.<span class="hljs-title function_">create</span>({
        <span class="hljs-attr">data</span>: {
          ...configData,
          <span class="hljs-attr">scoreElements</span>: {
            <span class="hljs-attr">create</span>: scoreElements || [],
          },
          <span class="hljs-attr">bonusConditions</span>: {
            <span class="hljs-attr">create</span>: bonusConditions || [],
          },
          <span class="hljs-attr">penaltyConditions</span>: {
            <span class="hljs-attr">create</span>: penaltyConditions || [],
          },
        },
        <span class="hljs-attr">include</span>: {
          <span class="hljs-attr">scoreElements</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">bonusConditions</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">penaltyConditions</span>: <span class="hljs-literal">true</span>,
        },
      });
      
      <span class="hljs-keyword">return</span> scoreConfig;
    });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getScoreConfigForTournament</span>(<span class="hljs-attr">tournamentId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ScoreConfig</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">scoreConfig</span>.<span class="hljs-title function_">findFirst</span>({
      <span class="hljs-attr">where</span>: { tournamentId },
      <span class="hljs-attr">include</span>: {
        <span class="hljs-attr">scoreElements</span>: {
          <span class="hljs-attr">orderBy</span>: { <span class="hljs-attr">displayOrder</span>: <span class="hljs-string">&#x27;asc&#x27;</span> },
        },
        <span class="hljs-attr">bonusConditions</span>: {
          <span class="hljs-attr">orderBy</span>: { <span class="hljs-attr">displayOrder</span>: <span class="hljs-string">&#x27;asc&#x27;</span> },
        },
        <span class="hljs-attr">penaltyConditions</span>: {
          <span class="hljs-attr">orderBy</span>: { <span class="hljs-attr">displayOrder</span>: <span class="hljs-string">&#x27;asc&#x27;</span> },
        },
      },
    });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getScoreConfigById</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ScoreConfig</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">scoreConfig</span>.<span class="hljs-title function_">findUnique</span>({
      <span class="hljs-attr">where</span>: { id },
      <span class="hljs-attr">include</span>: {
        <span class="hljs-attr">scoreElements</span>: {
          <span class="hljs-attr">orderBy</span>: { <span class="hljs-attr">displayOrder</span>: <span class="hljs-string">&#x27;asc&#x27;</span> },
        },
        <span class="hljs-attr">bonusConditions</span>: {
          <span class="hljs-attr">orderBy</span>: { <span class="hljs-attr">displayOrder</span>: <span class="hljs-string">&#x27;asc&#x27;</span> },
        },
        <span class="hljs-attr">penaltyConditions</span>: {
          <span class="hljs-attr">orderBy</span>: { <span class="hljs-attr">displayOrder</span>: <span class="hljs-string">&#x27;asc&#x27;</span> },
        },
      },
    });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">updateScoreConfig</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: <span class="hljs-title class_">UpdateScoreConfigDto</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ScoreConfig</span>&gt; {
    <span class="hljs-comment">// Implementation for updating score config</span>
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">addScoreElement</span>(<span class="hljs-attr">scoreConfigId</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: <span class="hljs-title class_">CreateScoreElementDto</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ScoreElement</span>&gt; {
    <span class="hljs-comment">// Implementation for adding a score element</span>
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">addBonusCondition</span>(<span class="hljs-attr">scoreConfigId</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: <span class="hljs-title class_">CreateBonusConditionDto</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">BonusCondition</span>&gt; {
    <span class="hljs-comment">// Implementation for adding a bonus condition</span>
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">addPenaltyCondition</span>(<span class="hljs-attr">scoreConfigId</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: <span class="hljs-title class_">CreatePenaltyConditionDto</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">PenaltyCondition</span>&gt; {
    <span class="hljs-comment">// Implementation for adding a penalty condition</span>
  }

  <span class="hljs-comment">// Other CRUD operations for elements, bonuses, penalties</span>
}
</code></pre>
<h4 id="scorecalculationservice">ScoreCalculationService</h4>
<pre><code class="language-typescript"><span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScoreCalculationService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> prisma: PrismaService,
    <span class="hljs-keyword">private</span> conditionEvaluatorFactory: ConditionEvaluatorFactory,
  </span>) {}

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">calculateMatchScore</span>(
    <span class="hljs-attr">matchId</span>: <span class="hljs-built_in">string</span>, 
    <span class="hljs-attr">allianceId</span>: <span class="hljs-built_in">string</span>, 
    <span class="hljs-attr">elementScores</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;,
    scoreConfigId?: <span class="hljs-built_in">string</span>
  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">MatchScore</span>&gt; {
    <span class="hljs-comment">// 1. Get the match and alliance to verify they exist</span>
    <span class="hljs-keyword">const</span> match = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">match</span>.<span class="hljs-title function_">findUnique</span>({
      <span class="hljs-attr">where</span>: { <span class="hljs-attr">id</span>: matchId },
      <span class="hljs-attr">include</span>: { 
        <span class="hljs-attr">stage</span>: { 
          <span class="hljs-attr">include</span>: { <span class="hljs-attr">tournament</span>: <span class="hljs-literal">true</span> } 
        } 
      },
    });
    
    <span class="hljs-keyword">if</span> (!match) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NotFoundException</span>(<span class="hljs-string">`Match with ID <span class="hljs-subst">${matchId}</span> not found`</span>);
    }
    
    <span class="hljs-keyword">const</span> alliance = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">alliance</span>.<span class="hljs-title function_">findUnique</span>({
      <span class="hljs-attr">where</span>: { <span class="hljs-attr">id</span>: allianceId },
    });
    
    <span class="hljs-keyword">if</span> (!alliance) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NotFoundException</span>(<span class="hljs-string">`Alliance with ID <span class="hljs-subst">${allianceId}</span> not found`</span>);
    }
    
    <span class="hljs-comment">// 2. Get the score config (either provided or from tournament)</span>
    <span class="hljs-keyword">const</span> configId = scoreConfigId || 
      (<span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">scoreConfig</span>.<span class="hljs-title function_">findFirst</span>({
        <span class="hljs-attr">where</span>: { <span class="hljs-attr">tournamentId</span>: match.<span class="hljs-property">stage</span>.<span class="hljs-property">tournamentId</span> },
        <span class="hljs-attr">orderBy</span>: { <span class="hljs-attr">createdAt</span>: <span class="hljs-string">&#x27;desc&#x27;</span> },
      }))?.<span class="hljs-property">id</span>;
    
    <span class="hljs-keyword">if</span> (!configId) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NotFoundException</span>(<span class="hljs-string">`No score configuration found for this match`</span>);
    }
    
    <span class="hljs-keyword">const</span> scoreConfig = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">scoreConfig</span>.<span class="hljs-title function_">findUnique</span>({
      <span class="hljs-attr">where</span>: { <span class="hljs-attr">id</span>: configId },
      <span class="hljs-attr">include</span>: {
        <span class="hljs-attr">scoreElements</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">bonusConditions</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">penaltyConditions</span>: <span class="hljs-literal">true</span>,
      },
    });
    
    <span class="hljs-comment">// 3. Calculate base scores from elementScores</span>
    <span class="hljs-keyword">let</span> totalScore = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-attr">calculationLog</span>: <span class="hljs-built_in">any</span> = { <span class="hljs-attr">elements</span>: [], <span class="hljs-attr">bonuses</span>: [], <span class="hljs-attr">penalties</span>: [] };
    
    <span class="hljs-comment">// Process each score element</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> element <span class="hljs-keyword">of</span> scoreConfig.<span class="hljs-property">scoreElements</span>) {
      <span class="hljs-keyword">const</span> value = elementScores[element.<span class="hljs-property">code</span>] || <span class="hljs-number">0</span>;
      <span class="hljs-keyword">const</span> elementScore = value * element.<span class="hljs-property">pointsPerUnit</span>;
      totalScore += elementScore;
      
      calculationLog.<span class="hljs-property">elements</span>.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">elementCode</span>: element.<span class="hljs-property">code</span>,
        <span class="hljs-attr">elementName</span>: element.<span class="hljs-property">name</span>,
        value,
        <span class="hljs-attr">pointsPerUnit</span>: element.<span class="hljs-property">pointsPerUnit</span>,
        <span class="hljs-attr">totalPoints</span>: elementScore,
      });
    }
    
    <span class="hljs-comment">// 4. Evaluate bonus conditions</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">bonusesEarned</span>: <span class="hljs-built_in">string</span>[] = [];
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> bonus <span class="hljs-keyword">of</span> scoreConfig.<span class="hljs-property">bonusConditions</span>) {
      <span class="hljs-keyword">const</span> conditionEvaluator = <span class="hljs-variable language_">this</span>.<span class="hljs-property">conditionEvaluatorFactory</span>.<span class="hljs-title function_">createEvaluator</span>(bonus.<span class="hljs-property">condition</span>);
      <span class="hljs-keyword">const</span> conditionMet = conditionEvaluator.evaluate(elementScores);
      
      <span class="hljs-keyword">if</span> (conditionMet) {
        totalScore += bonus.<span class="hljs-property">bonusPoints</span>;
        bonusesEarned.<span class="hljs-title function_">push</span>(bonus.<span class="hljs-property">id</span>);
        
        calculationLog.<span class="hljs-property">bonuses</span>.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">bonusCode</span>: bonus.<span class="hljs-property">code</span>,
          <span class="hljs-attr">bonusName</span>: bonus.<span class="hljs-property">name</span>,
          <span class="hljs-attr">bonusPoints</span>: bonus.<span class="hljs-property">bonusPoints</span>,
        });
      }
    }
    
    <span class="hljs-comment">// 5. Evaluate penalty conditions</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">penaltiesIncurred</span>: <span class="hljs-built_in">string</span>[] = [];
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> penalty <span class="hljs-keyword">of</span> scoreConfig.<span class="hljs-property">penaltyConditions</span>) {
      <span class="hljs-keyword">const</span> conditionEvaluator = <span class="hljs-variable language_">this</span>.<span class="hljs-property">conditionEvaluatorFactory</span>.<span class="hljs-title function_">createEvaluator</span>(penalty.<span class="hljs-property">condition</span>);
      <span class="hljs-keyword">const</span> conditionMet = conditionEvaluator.evaluate(elementScores);
      
      <span class="hljs-keyword">if</span> (conditionMet) {
        totalScore += penalty.<span class="hljs-property">penaltyPoints</span>; <span class="hljs-comment">// Note: penalty points are already negative</span>
        penaltiesIncurred.<span class="hljs-title function_">push</span>(penalty.<span class="hljs-property">id</span>);
        
        calculationLog.<span class="hljs-property">penalties</span>.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">penaltyCode</span>: penalty.<span class="hljs-property">code</span>,
          <span class="hljs-attr">penaltyName</span>: penalty.<span class="hljs-property">name</span>,
          <span class="hljs-attr">penaltyPoints</span>: penalty.<span class="hljs-property">penaltyPoints</span>,
        });
      }
    }
    
    calculationLog.<span class="hljs-property">totalScore</span> = totalScore;
    
    <span class="hljs-comment">// 6. Save and return MatchScore</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">matchScore</span>.<span class="hljs-title function_">upsert</span>({
      <span class="hljs-attr">where</span>: {
        <span class="hljs-attr">matchId_allianceId</span>: {
          matchId,
          allianceId,
        },
      },
      <span class="hljs-attr">update</span>: {
        <span class="hljs-attr">scoreConfigId</span>: configId,
        elementScores,
        bonusesEarned,
        penaltiesIncurred,
        calculationLog,
        totalScore,
      },
      <span class="hljs-attr">create</span>: {
        matchId,
        allianceId,
        <span class="hljs-attr">scoreConfigId</span>: configId,
        elementScores,
        bonusesEarned,
        penaltiesIncurred,
        calculationLog,
        totalScore,
      },
    });
  }
}
</code></pre>
<h4 id="conditionevaluator-strategy-pattern">ConditionEvaluator Strategy Pattern</h4>
<pre><code class="language-typescript"><span class="hljs-comment">// interfaces/condition.interface.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Condition</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>;
  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ConditionEvaluator</span> {
  evaluate(<span class="hljs-attr">elementScores</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;): <span class="hljs-built_in">boolean</span>;
}

<span class="hljs-comment">// strategies/condition-evaluator.strategy.ts</span>
<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConditionEvaluatorFactory</span> {
  <span class="hljs-title function_">createEvaluator</span>(<span class="hljs-attr">condition</span>: <span class="hljs-title class_">Condition</span>): <span class="hljs-title class_">ConditionEvaluator</span> {
    <span class="hljs-keyword">switch</span> (condition.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;threshold&#x27;</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThresholdConditionEvaluator</span>(condition);
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;composite&#x27;</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompositeConditionEvaluator</span>(condition, <span class="hljs-variable language_">this</span>);
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Unknown condition type: <span class="hljs-subst">${condition.<span class="hljs-keyword">type</span>}</span>`</span>);
    }
  }
}

<span class="hljs-comment">// strategies/threshold-condition.strategy.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThresholdConditionEvaluator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConditionEvaluator</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">elementCode</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">operator</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span>;
  
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">condition: Condition</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">elementCode</span> = condition.<span class="hljs-property">elementCode</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">operator</span> = condition.<span class="hljs-property">operator</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = condition.<span class="hljs-property">value</span>;
  }
  
  evaluate(<span class="hljs-attr">elementScores</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">const</span> elementValue = elementScores[<span class="hljs-variable language_">this</span>.<span class="hljs-property">elementCode</span>] || <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">switch</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">operator</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;==&#x27;</span>: <span class="hljs-keyword">return</span> elementValue === <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;!=&#x27;</span>: <span class="hljs-keyword">return</span> elementValue !== <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;&gt;&#x27;</span>: <span class="hljs-keyword">return</span> elementValue &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;&gt;=&#x27;</span>: <span class="hljs-keyword">return</span> elementValue &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;&lt;&#x27;</span>: <span class="hljs-keyword">return</span> elementValue &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;&lt;=&#x27;</span>: <span class="hljs-keyword">return</span> elementValue &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
      <span class="hljs-attr">default</span>: <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Unknown operator: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.operator}</span>`</span>);
    }
  }
}

<span class="hljs-comment">// strategies/composite-condition.strategy.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CompositeConditionEvaluator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConditionEvaluator</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">operator</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">conditions</span>: <span class="hljs-title class_">ConditionEvaluator</span>[];
  
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    condition: Condition,
    <span class="hljs-keyword">private</span> factory: ConditionEvaluatorFactory,
  </span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">operator</span> = condition.<span class="hljs-property">operator</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">conditions</span> = condition.<span class="hljs-property">conditions</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> factory.<span class="hljs-title function_">createEvaluator</span>(c));
  }
  
  evaluate(<span class="hljs-attr">elementScores</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">operator</span> === <span class="hljs-string">&#x27;AND&#x27;</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">conditions</span>.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c.evaluate(elementScores));
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">operator</span> === <span class="hljs-string">&#x27;OR&#x27;</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">conditions</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c.evaluate(elementScores));
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Unknown composite operator: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.operator}</span>`</span>);
    }
  }
}
</code></pre>
<h3 id="23-controller-layer">2.3 Controller Layer</h3>
<pre><code class="language-typescript"><span class="hljs-meta">@Controller</span>(<span class="hljs-string">&#x27;score-configs&#x27;</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScoreConfigController</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> scoreConfigService: ScoreConfigService</span>) {}

  <span class="hljs-meta">@Post</span>()
  <span class="hljs-meta">@UseGuards</span>(<span class="hljs-title class_">JwtAuthGuard</span>, <span class="hljs-title class_">RolesGuard</span>)
  <span class="hljs-meta">@Roles</span>(<span class="hljs-string">&#x27;ADMIN&#x27;</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-params"><span class="hljs-meta">@Body</span>() createScoreConfigDto: CreateScoreConfigDto</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">scoreConfigService</span>.<span class="hljs-title function_">createScoreConfig</span>(createScoreConfigDto);
  }

  <span class="hljs-meta">@Get</span>(<span class="hljs-string">&#x27;tournament/:tournamentId&#x27;</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getForTournament</span>(<span class="hljs-params"><span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;tournamentId&#x27;</span>) tournamentId: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">scoreConfigService</span>.<span class="hljs-title function_">getScoreConfigForTournament</span>(tournamentId);
  }

  <span class="hljs-meta">@Get</span>(<span class="hljs-string">&#x27;:id&#x27;</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">findOne</span>(<span class="hljs-params"><span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;id&#x27;</span>) id: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">scoreConfigService</span>.<span class="hljs-title function_">getScoreConfigById</span>(id);
  }

  <span class="hljs-meta">@Patch</span>(<span class="hljs-string">&#x27;:id&#x27;</span>)
  <span class="hljs-meta">@UseGuards</span>(<span class="hljs-title class_">JwtAuthGuard</span>, <span class="hljs-title class_">RolesGuard</span>)
  <span class="hljs-meta">@Roles</span>(<span class="hljs-string">&#x27;ADMIN&#x27;</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">
    <span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;id&#x27;</span>) id: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Body</span>() updateScoreConfigDto: UpdateScoreConfigDto,
  </span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">scoreConfigService</span>.<span class="hljs-title function_">updateScoreConfig</span>(id, updateScoreConfigDto);
  }

  <span class="hljs-meta">@Post</span>(<span class="hljs-string">&#x27;:id/elements&#x27;</span>)
  <span class="hljs-meta">@UseGuards</span>(<span class="hljs-title class_">JwtAuthGuard</span>, <span class="hljs-title class_">RolesGuard</span>)
  <span class="hljs-meta">@Roles</span>(<span class="hljs-string">&#x27;ADMIN&#x27;</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">addElement</span>(<span class="hljs-params">
    <span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;id&#x27;</span>) id: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Body</span>() createScoreElementDto: CreateScoreElementDto,
  </span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">scoreConfigService</span>.<span class="hljs-title function_">addScoreElement</span>(id, createScoreElementDto);
  }

  <span class="hljs-comment">// Additional endpoints for bonuses, penalties, etc.</span>
}

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">&#x27;match-scores&#x27;</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MatchScoresController</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> scoreCalculationService: ScoreCalculationService,
    <span class="hljs-keyword">private</span> matchesService: MatchesService,
  </span>) {}

  <span class="hljs-meta">@Post</span>(<span class="hljs-string">&#x27;:matchId/alliance/:allianceId&#x27;</span>)
  <span class="hljs-meta">@UseGuards</span>(<span class="hljs-title class_">JwtAuthGuard</span>, <span class="hljs-title class_">RolesGuard</span>)
  <span class="hljs-meta">@Roles</span>(<span class="hljs-string">&#x27;REFEREE&#x27;</span>, <span class="hljs-string">&#x27;ADMIN&#x27;</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">submitMatchScore</span>(<span class="hljs-params">
    <span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;matchId&#x27;</span>) matchId: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;allianceId&#x27;</span>) allianceId: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Body</span>() scoreData: SubmitScoreDto,
  </span>) {
    <span class="hljs-keyword">const</span> matchScore = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">scoreCalculationService</span>.<span class="hljs-title function_">calculateMatchScore</span>(
      matchId,
      allianceId,
      scoreData.<span class="hljs-property">elementScores</span>,
      scoreData.<span class="hljs-property">scoreConfigId</span>,
    );
    
    <span class="hljs-comment">// Update alliance score in the Alliance model</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">matchesService</span>.<span class="hljs-title function_">updateAllianceScore</span>(allianceId, matchScore.<span class="hljs-property">totalScore</span>);
    
    <span class="hljs-keyword">return</span> matchScore;
  }

  <span class="hljs-meta">@Get</span>(<span class="hljs-string">&#x27;:matchId/alliance/:allianceId&#x27;</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getMatchScore</span>(<span class="hljs-params">
    <span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;matchId&#x27;</span>) matchId: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;allianceId&#x27;</span>) allianceId: <span class="hljs-built_in">string</span>,
  </span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">matchScore</span>.<span class="hljs-title function_">findUnique</span>({
      <span class="hljs-attr">where</span>: {
        <span class="hljs-attr">matchId_allianceId</span>: {
          matchId,
          allianceId,
        },
      },
      <span class="hljs-attr">include</span>: {
        <span class="hljs-attr">scoreConfig</span>: {
          <span class="hljs-attr">include</span>: {
            <span class="hljs-attr">scoreElements</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">bonusConditions</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">penaltyConditions</span>: <span class="hljs-literal">true</span>,
          },
        },
      },
    });
  }
}
</code></pre>
<h3 id="24-dtos">2.4 DTOs</h3>
<pre><code class="language-typescript"><span class="hljs-comment">// dto/create-score-config.dto.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateScoreConfigDto</span> {
  <span class="hljs-meta">@IsString</span>()
  <span class="hljs-meta">@IsNotEmpty</span>()
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@IsString</span>()
  <span class="hljs-meta">@IsOptional</span>()
  description?: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@IsString</span>()
  <span class="hljs-meta">@IsNotEmpty</span>()
  <span class="hljs-attr">tournamentId</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@IsArray</span>()
  <span class="hljs-meta">@IsOptional</span>()
  <span class="hljs-meta">@ValidateNested</span>({ <span class="hljs-attr">each</span>: <span class="hljs-literal">true</span> })
  <span class="hljs-meta">@Type</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">CreateScoreElementDto</span>)
  scoreElements?: <span class="hljs-title class_">CreateScoreElementDto</span>[];

  <span class="hljs-meta">@IsArray</span>()
  <span class="hljs-meta">@IsOptional</span>()
  <span class="hljs-meta">@ValidateNested</span>({ <span class="hljs-attr">each</span>: <span class="hljs-literal">true</span> })
  <span class="hljs-meta">@Type</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">CreateBonusConditionDto</span>)
  bonusConditions?: <span class="hljs-title class_">CreateBonusConditionDto</span>[];

  <span class="hljs-meta">@IsArray</span>()
  <span class="hljs-meta">@IsOptional</span>()
  <span class="hljs-meta">@ValidateNested</span>({ <span class="hljs-attr">each</span>: <span class="hljs-literal">true</span> })
  <span class="hljs-meta">@Type</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">CreatePenaltyConditionDto</span>)
  penaltyConditions?: <span class="hljs-title class_">CreatePenaltyConditionDto</span>[];
}

<span class="hljs-comment">// dto/create-score-element.dto.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateScoreElementDto</span> {
  <span class="hljs-meta">@IsString</span>()
  <span class="hljs-meta">@IsNotEmpty</span>()
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@IsString</span>()
  <span class="hljs-meta">@IsNotEmpty</span>()
  <span class="hljs-attr">code</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@IsString</span>()
  <span class="hljs-meta">@IsOptional</span>()
  description?: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@IsInt</span>()
  <span class="hljs-attr">pointsPerUnit</span>: <span class="hljs-built_in">number</span>;

  <span class="hljs-meta">@IsInt</span>()
  <span class="hljs-meta">@IsOptional</span>()
  maxUnits?: <span class="hljs-built_in">number</span>;

  <span class="hljs-meta">@IsString</span>()
  <span class="hljs-meta">@IsOptional</span>()
  category?: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@IsString</span>()
  <span class="hljs-meta">@IsIn</span>([<span class="hljs-string">&#x27;counter&#x27;</span>, <span class="hljs-string">&#x27;boolean&#x27;</span>])
  <span class="hljs-attr">elementType</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@IsInt</span>()
  <span class="hljs-meta">@IsOptional</span>()
  displayOrder?: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;

  <span class="hljs-meta">@IsString</span>()
  <span class="hljs-meta">@IsOptional</span>()
  icon?: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@IsString</span>()
  <span class="hljs-meta">@IsOptional</span>()
  color?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// dto/submit-score.dto.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubmitScoreDto</span> {
  <span class="hljs-meta">@IsObject</span>()
  <span class="hljs-meta">@ValidateNested</span>()
  <span class="hljs-attr">elementScores</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;;

  <span class="hljs-meta">@IsString</span>()
  <span class="hljs-meta">@IsOptional</span>()
  scoreConfigId?: <span class="hljs-built_in">string</span>;
}
</code></pre>
<h2 id="3-frontend-implementation-nextjs">3. Frontend Implementation (Next.js)</h2>
<h3 id="31-directory-structure">3.1 Directory Structure</h3>
<pre><code>src/
├── app/
│   ├── admin/
│   │   ├── tournaments/
│   │   │   ├── [tournamentId]/
│   │   │   │   ├── score-config/
│   │   │   │   │   ├── page.tsx
│   │   │   │   │   ├── create/
│   │   │   │   │   │   └── page.tsx
│   │   │   │   │   └── [configId]/
│   │   │   │   │       ├── page.tsx
│   │   │   │   │       └── edit/
│   │   │   │   │           └── page.tsx
│   │   │   │   └── matches/
│   │   │   │       └── [matchId]/
│   │   │   │           └── scoring/
│   │   │   │               └── page.tsx
│   ├── referee/
│   │   ├── matches/
│   │   │   └── [matchId]/
│   │   │       └── scoring/
│   │   │           └── page.tsx
│   └── audience/
│       └── matches/
│           └── [matchId]/
│               └── scores/
│                   └── page.tsx
├── components/
│   ├── scoring/
│   │   ├── ScoreConfigForm.tsx
│   │   ├── ScoreElementForm.tsx
│   │   ├── BonusConditionForm.tsx
│   │   ├── PenaltyConditionForm.tsx
│   │   ├── ConditionBuilder.tsx
│   │   ├── DynamicScoreInput.tsx
│   │   ├── ScoreDisplay.tsx
│   │   └── ScoreSummary.tsx
│   └── ui/
│       ├── Counter.tsx
│       ├── Checkbox.tsx
│       └── ...
├── hooks/
│   ├── tanstack-query/
│   │   ├── useScoreConfig.ts
│   │   ├── useCreateScoreConfig.ts
│   │   ├── useUpdateScoreConfig.ts
│   │   ├── useMatchScore.ts
│   │   └── useSubmitScore.ts
│   └── ...
├── lib/
│   ├── api-client.ts
│   └── score-calculation.ts
└── types/
    ├── score-config.ts
    ├── match-score.ts
    └── condition.ts
</code></pre>
<h3 id="32-types">3.2 Types</h3>
<pre><code class="language-typescript"><span class="hljs-comment">// types/score-config.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ScoreConfig</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">tournamentId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  description?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">scoreElements</span>: <span class="hljs-title class_">ScoreElement</span>[];
  <span class="hljs-attr">bonusConditions</span>: <span class="hljs-title class_">BonusCondition</span>[];
  <span class="hljs-attr">penaltyConditions</span>: <span class="hljs-title class_">PenaltyCondition</span>[];
  <span class="hljs-attr">createdAt</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">updatedAt</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ScoreElement</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">scoreConfigId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">code</span>: <span class="hljs-built_in">string</span>;
  description?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">pointsPerUnit</span>: <span class="hljs-built_in">number</span>;
  maxUnits?: <span class="hljs-built_in">number</span>;
  category?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">elementType</span>: <span class="hljs-string">&#x27;counter&#x27;</span> | <span class="hljs-string">&#x27;boolean&#x27;</span>;
  <span class="hljs-attr">displayOrder</span>: <span class="hljs-built_in">number</span>;
  icon?: <span class="hljs-built_in">string</span>;
  color?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Condition</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;threshold&#x27;</span> | <span class="hljs-string">&#x27;composite&#x27;</span>;
  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ThresholdCondition</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Condition</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;threshold&#x27;</span>;
  <span class="hljs-attr">elementCode</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">operator</span>: <span class="hljs-string">&#x27;==&#x27;</span> | <span class="hljs-string">&#x27;!=&#x27;</span> | <span class="hljs-string">&#x27;&gt;&#x27;</span> | <span class="hljs-string">&#x27;&gt;=&#x27;</span> | <span class="hljs-string">&#x27;&lt;&#x27;</span> | <span class="hljs-string">&#x27;&lt;=&#x27;</span>;
  <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CompositeCondition</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Condition</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;composite&#x27;</span>;
  <span class="hljs-attr">operator</span>: <span class="hljs-string">&#x27;AND&#x27;</span> | <span class="hljs-string">&#x27;OR&#x27;</span>;
  <span class="hljs-attr">conditions</span>: <span class="hljs-title class_">Condition</span>[];
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BonusCondition</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">scoreConfigId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">code</span>: <span class="hljs-built_in">string</span>;
  description?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">bonusPoints</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">condition</span>: <span class="hljs-title class_">Condition</span>;
  <span class="hljs-attr">displayOrder</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PenaltyCondition</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">scoreConfigId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">code</span>: <span class="hljs-built_in">string</span>;
  description?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">penaltyPoints</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">condition</span>: <span class="hljs-title class_">Condition</span>;
  <span class="hljs-attr">displayOrder</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">// types/match-score.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MatchScore</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">matchId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">allianceId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">scoreConfigId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">elementScores</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;;
  <span class="hljs-attr">bonusesEarned</span>: <span class="hljs-built_in">string</span>[];
  <span class="hljs-attr">penaltiesIncurred</span>: <span class="hljs-built_in">string</span>[];
  calculationLog?: <span class="hljs-built_in">any</span>;
  <span class="hljs-attr">totalScore</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">createdAt</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">updatedAt</span>: <span class="hljs-built_in">string</span>;
  scoreConfig?: <span class="hljs-title class_">ScoreConfig</span>;
}
</code></pre>
<h3 id="33-tanstack-query-hooks">3.3 TanStack Query Hooks</h3>
<pre><code class="language-typescript"><span class="hljs-comment">// hooks/tanstack-query/useScoreConfig.ts</span>
<span class="hljs-keyword">import</span> { useQuery } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@tanstack/react-query&#x27;</span>;
<span class="hljs-keyword">import</span> { apiClient } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/api-client&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ScoreConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/types/score-config&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useScoreConfig</span> = (<span class="hljs-params">tournamentId: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> useQuery&lt;<span class="hljs-title class_">ScoreConfig</span>&gt;({
    <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">&#x27;scoreConfig&#x27;</span>, tournamentId],
    <span class="hljs-attr">queryFn</span>: <span class="hljs-function">() =&gt;</span> apiClient.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/score-configs/tournament/<span class="hljs-subst">${tournamentId}</span>`</span>),
  });
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useScoreConfigById</span> = (<span class="hljs-params">configId: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> useQuery&lt;<span class="hljs-title class_">ScoreConfig</span>&gt;({
    <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">&#x27;scoreConfig&#x27;</span>, configId],
    <span class="hljs-attr">queryFn</span>: <span class="hljs-function">() =&gt;</span> apiClient.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/score-configs/<span class="hljs-subst">${configId}</span>`</span>),
    <span class="hljs-attr">enabled</span>: !!configId,
  });
};

<span class="hljs-comment">// hooks/tanstack-query/useCreateScoreConfig.ts</span>
<span class="hljs-keyword">import</span> { useMutation, useQueryClient } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@tanstack/react-query&#x27;</span>;
<span class="hljs-keyword">import</span> { apiClient } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/api-client&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ScoreConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/types/score-config&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useCreateScoreConfig</span> = (<span class="hljs-params"></span>) =&gt; {
  <span class="hljs-keyword">const</span> queryClient = <span class="hljs-title function_">useQueryClient</span>();
  
  <span class="hljs-keyword">return</span> useMutation&lt;
    <span class="hljs-title class_">ScoreConfig</span>, 
    <span class="hljs-title class_">Error</span>, 
    { 
      <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; 
      description?: <span class="hljs-built_in">string</span>; 
      <span class="hljs-attr">tournamentId</span>: <span class="hljs-built_in">string</span>;
      scoreElements?: <span class="hljs-built_in">any</span>[];
      bonusConditions?: <span class="hljs-built_in">any</span>[];
      penaltyConditions?: <span class="hljs-built_in">any</span>[];
    }
  &gt;({
    <span class="hljs-attr">mutationFn</span>: <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> apiClient.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/score-configs&#x27;</span>, data),
    <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      queryClient.<span class="hljs-title function_">invalidateQueries</span>({ <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">&#x27;scoreConfig&#x27;</span>, data.<span class="hljs-property">tournamentId</span>] });
    },
  });
};

<span class="hljs-comment">// hooks/tanstack-query/useMatchScore.ts</span>
<span class="hljs-keyword">import</span> { useQuery } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@tanstack/react-query&#x27;</span>;
<span class="hljs-keyword">import</span> { apiClient } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/api-client&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MatchScore</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/types/match-score&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useMatchScore</span> = (<span class="hljs-params">matchId: <span class="hljs-built_in">string</span>, allianceId: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> useQuery&lt;<span class="hljs-title class_">MatchScore</span>&gt;({
    <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">&#x27;matchScore&#x27;</span>, matchId, allianceId],
    <span class="hljs-attr">queryFn</span>: <span class="hljs-function">() =&gt;</span> apiClient.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/match-scores/<span class="hljs-subst">${matchId}</span>/alliance/<span class="hljs-subst">${allianceId}</span>`</span>),
  });
};

<span class="hljs-comment">// hooks/tanstack-query/useSubmitScore.ts</span>
<span class="hljs-keyword">import</span> { useMutation, useQueryClient } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@tanstack/react-query&#x27;</span>;
<span class="hljs-keyword">import</span> { apiClient } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/lib/api-client&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MatchScore</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/types/match-score&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useSubmitScore</span> = (<span class="hljs-params">matchId: <span class="hljs-built_in">string</span>, allianceId: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> queryClient = <span class="hljs-title function_">useQueryClient</span>();
  
  <span class="hljs-keyword">return</span> useMutation&lt;
    <span class="hljs-title class_">MatchScore</span>, 
    <span class="hljs-title class_">Error</span>, 
    { 
      <span class="hljs-attr">elementScores</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;; 
      scoreConfigId?: <span class="hljs-built_in">string</span>;
    }
  &gt;({
    <span class="hljs-attr">mutationFn</span>: <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> 
      apiClient.<span class="hljs-title function_">post</span>(<span class="hljs-string">`/match-scores/<span class="hljs-subst">${matchId}</span>/alliance/<span class="hljs-subst">${allianceId}</span>`</span>, data),
    <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">() =&gt;</span> {
      queryClient.<span class="hljs-title function_">invalidateQueries</span>({ <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">&#x27;matchScore&#x27;</span>, matchId, allianceId] });
      <span class="hljs-comment">// Also invalidate the match data to update alliance scores</span>
      queryClient.<span class="hljs-title function_">invalidateQueries</span>({ <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">&#x27;match&#x27;</span>, matchId] });
    },
  });
};
</code></pre>
<h3 id="34-components">3.4 Components</h3>
<h4 id="scoreconfigform-component">ScoreConfigForm Component</h4>
<pre><code class="language-tsx"><span class="hljs-comment">// components/scoring/ScoreConfigForm.tsx</span>
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/navigation&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span>, <span class="hljs-title class_">Input</span>, <span class="hljs-title class_">Textarea</span>, <span class="hljs-title class_">Card</span>, <span class="hljs-title class_">Tabs</span>, <span class="hljs-title class_">TabsContent</span>, <span class="hljs-title class_">TabsList</span>, <span class="hljs-title class_">TabsTrigger</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/ui&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ScoreElementForm</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./ScoreElementForm&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BonusConditionForm</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./BonusConditionForm&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PenaltyConditionForm</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./PenaltyConditionForm&#x27;</span>;
<span class="hljs-keyword">import</span> { useCreateScoreConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/hooks/tanstack-query/useCreateScoreConfig&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ScoreConfig</span>, <span class="hljs-title class_">ScoreElement</span>, <span class="hljs-title class_">BonusCondition</span>, <span class="hljs-title class_">PenaltyCondition</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/types/score-config&#x27;</span>;

interface <span class="hljs-title class_">ScoreConfigFormProps</span> {
  <span class="hljs-attr">tournamentId</span>: string;
  initialData?: <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">ScoreConfig</span>&gt;;
  isEditing?: boolean;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">ScoreConfigForm</span> = (<span class="hljs-params">{ 
  tournamentId, 
  initialData = {}, 
  isEditing = <span class="hljs-literal">false</span> 
}: ScoreConfigFormProps</span>) =&gt; {
  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
  <span class="hljs-keyword">const</span> createMutation = <span class="hljs-title function_">useCreateScoreConfig</span>();
  
  <span class="hljs-keyword">const</span> [formData, setFormData] = <span class="hljs-title function_">useState</span>({
    <span class="hljs-attr">name</span>: initialData.<span class="hljs-property">name</span> || <span class="hljs-string">&#x27;&#x27;</span>,
    <span class="hljs-attr">description</span>: initialData.<span class="hljs-property">description</span> || <span class="hljs-string">&#x27;&#x27;</span>,
    tournamentId,
  });
  
  <span class="hljs-keyword">const</span> [scoreElements, setScoreElements] = useState&lt;<span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">ScoreElement</span>&gt;[]&gt;(
    initialData.<span class="hljs-property">scoreElements</span> || []
  );
  
  <span class="hljs-keyword">const</span> [bonusConditions, setBonusConditions] = useState&lt;<span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">BonusCondition</span>&gt;[]&gt;(
    initialData.<span class="hljs-property">bonusConditions</span> || []
  );
  
  <span class="hljs-keyword">const</span> [penaltyConditions, setPenaltyConditions] = useState&lt;<span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">PenaltyCondition</span>&gt;[]&gt;(
    initialData.<span class="hljs-property">penaltyConditions</span> || []
  );
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleInputChange</span> = (<span class="hljs-params">e: React.ChangeEvent&lt;HTMLInputElement | HTMLTextAreaElement&gt;</span>) =&gt; {
    <span class="hljs-keyword">const</span> { name, value } = e.<span class="hljs-property">target</span>;
    <span class="hljs-title function_">setFormData</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({ ...prev, [name]: value }));
  };
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleAddScoreElement</span> = (<span class="hljs-params">element: Partial&lt;ScoreElement&gt;</span>) =&gt; {
    <span class="hljs-title function_">setScoreElements</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> [...prev, { ...element, <span class="hljs-attr">displayOrder</span>: prev.<span class="hljs-property">length</span> }]);
  };
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleAddBonusCondition</span> = (<span class="hljs-params">bonus: Partial&lt;BonusCondition&gt;</span>) =&gt; {
    <span class="hljs-title function_">setBonusConditions</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> [...prev, { ...bonus, <span class="hljs-attr">displayOrder</span>: prev.<span class="hljs-property">length</span> }]);
  };
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleAddPenaltyCondition</span> = (<span class="hljs-params">penalty: Partial&lt;PenaltyCondition&gt;</span>) =&gt; {
    <span class="hljs-title function_">setPenaltyConditions</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> [...prev, { ...penalty, <span class="hljs-attr">displayOrder</span>: prev.<span class="hljs-property">length</span> }]);
  };
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">e: React.FormEvent</span>) =&gt; {
    e.<span class="hljs-title function_">preventDefault</span>();
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> payload = {
        ...formData,
        scoreElements,
        bonusConditions,
        penaltyConditions,
      };
      
      <span class="hljs-keyword">if</span> (isEditing &amp;&amp; initialData.<span class="hljs-property">id</span>) {
        <span class="hljs-comment">// Handle update logic</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">await</span> createMutation.<span class="hljs-title function_">mutateAsync</span>(payload);
        router.<span class="hljs-title function_">push</span>(<span class="hljs-string">`/admin/tournaments/<span class="hljs-subst">${tournamentId}</span>/score-config`</span>);
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Error saving score config:&#x27;</span>, error);
    }
  };
  
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSubmit}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-8&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Card</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-6&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-2xl font-bold mb-4&quot;</span>&gt;</span>
          {isEditing ? &#x27;Edit Score Configuration&#x27; : &#x27;Create Score Configuration&#x27;}
        <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-4&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">htmlFor</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;block text-sm font-medium&quot;</span>&gt;</span>
              Configuration Name
            <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Input</span>
              <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;name&quot;</span>
              <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span>
              <span class="hljs-attr">value</span>=<span class="hljs-string">{formData.name}</span>
              <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleInputChange}</span>
              <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;e.g., Fire Fighting Competition 2025&quot;</span>
              <span class="hljs-attr">required</span>
            /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">htmlFor</span>=<span class="hljs-string">&quot;description&quot;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;block text-sm font-medium&quot;</span>&gt;</span>
              Description
            <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Textarea</span>
              <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;description&quot;</span>
              <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;description&quot;</span>
              <span class="hljs-attr">value</span>=<span class="hljs-string">{formData.description}</span>
              <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleInputChange}</span>
              <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;Describe the scoring system...&quot;</span>
              <span class="hljs-attr">rows</span>=<span class="hljs-string">{3}</span>
            /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">Tabs</span> <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">&quot;elements&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">TabsList</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">TabsTrigger</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;elements&quot;</span>&gt;</span>Score Elements<span class="hljs-tag">&lt;/<span class="hljs-name">TabsTrigger</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">TabsTrigger</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;bonuses&quot;</span>&gt;</span>Bonus Conditions<span class="hljs-tag">&lt;/<span class="hljs-name">TabsTrigger</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">TabsTrigger</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;penalties&quot;</span>&gt;</span>Penalty Conditions<span class="hljs-tag">&lt;/<span class="hljs-name">TabsTrigger</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">TabsList</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">TabsContent</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;elements&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Card</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-6&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-bold mb-4&quot;</span>&gt;</span>Score Elements<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-4&quot;</span>&gt;</span>
              {scoreElements.map((element, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-4 border rounded-md&quot;</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>{element.name}<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{element.pointsPerUnit} points per {element.elementType === &#x27;boolean&#x27; ? &#x27;yes&#x27; : &#x27;unit&#x27;}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                  {/* Add edit/delete buttons */}
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              ))}
              
              <span class="hljs-tag">&lt;<span class="hljs-name">ScoreElementForm</span> <span class="hljs-attr">onAdd</span>=<span class="hljs-string">{handleAddScoreElement}</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">TabsContent</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">TabsContent</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;bonuses&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Card</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-6&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-bold mb-4&quot;</span>&gt;</span>Bonus Conditions<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-4&quot;</span>&gt;</span>
              {bonusConditions.map((bonus, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-4 border rounded-md&quot;</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>{bonus.name}<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>+{bonus.bonusPoints} points when condition is met<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                  {/* Add edit/delete buttons */}
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              ))}
              
              <span class="hljs-tag">&lt;<span class="hljs-name">BonusConditionForm</span> 
                <span class="hljs-attr">onAdd</span>=<span class="hljs-string">{handleAddBonusCondition}</span> 
                <span class="hljs-attr">scoreElements</span>=<span class="hljs-string">{scoreElements}</span> 
              /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">TabsContent</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">TabsContent</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;penalties&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Card</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-6&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-bold mb-4&quot;</span>&gt;</span>Penalty Conditions<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-4&quot;</span>&gt;</span>
              {penaltyConditions.map((penalty, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-4 border rounded-md&quot;</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>{penalty.name}<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{penalty.penaltyPoints} points when condition is met<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                  {/* Add edit/delete buttons */}
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              ))}
              
              <span class="hljs-tag">&lt;<span class="hljs-name">PenaltyConditionForm</span> 
                <span class="hljs-attr">onAdd</span>=<span class="hljs-string">{handleAddPenaltyCondition}</span> 
                <span class="hljs-attr">scoreElements</span>=<span class="hljs-string">{scoreElements}</span> 
              /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">TabsContent</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Tabs</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex justify-end space-x-4&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> 
          <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> 
          <span class="hljs-attr">variant</span>=<span class="hljs-string">&quot;outline&quot;</span> 
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> router.push(`/admin/tournaments/${tournamentId}/score-config`)}
        &gt;
          Cancel
        <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> 
          <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> 
          <span class="hljs-attr">disabled</span>=<span class="hljs-string">{createMutation.isPending}</span>
        &gt;</span>
          {createMutation.isPending ? &#x27;Saving...&#x27; : isEditing ? &#x27;Update&#x27; : &#x27;Create&#x27;}
        <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  );
};
</code></pre>
<h4 id="conditionbuilder-component">ConditionBuilder Component</h4>
<pre><code class="language-tsx"><span class="hljs-comment">// components/scoring/ConditionBuilder.tsx</span>
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span>, <span class="hljs-title class_">Select</span>, <span class="hljs-title class_">SelectContent</span>, <span class="hljs-title class_">SelectItem</span>, <span class="hljs-title class_">SelectTrigger</span>, <span class="hljs-title class_">SelectValue</span>, <span class="hljs-title class_">Input</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/ui&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Condition</span>, <span class="hljs-title class_">ThresholdCondition</span>, <span class="hljs-title class_">CompositeCondition</span>, <span class="hljs-title class_">ScoreElement</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/types/score-config&#x27;</span>;

interface <span class="hljs-title class_">ConditionBuilderProps</span> {
  <span class="hljs-attr">scoreElements</span>: <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">ScoreElement</span>&gt;[];
  initialCondition?: <span class="hljs-title class_">Condition</span>;
  <span class="hljs-attr">onChange</span>: <span class="hljs-function">(<span class="hljs-params">condition: Condition</span>) =&gt;</span> <span class="hljs-keyword">void</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">ConditionBuilder</span> = (<span class="hljs-params">{ 
  scoreElements, 
  initialCondition, 
  onChange 
}: ConditionBuilderProps</span>) =&gt; {
  <span class="hljs-keyword">const</span> [conditionType, setConditionType] = useState&lt;<span class="hljs-string">&#x27;threshold&#x27;</span> | <span class="hljs-string">&#x27;composite&#x27;</span>&gt;(
    initialCondition?.<span class="hljs-property">type</span> || <span class="hljs-string">&#x27;threshold&#x27;</span>
  );
  
  <span class="hljs-keyword">const</span> [thresholdCondition, setThresholdCondition] = useState&lt;<span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">ThresholdCondition</span>&gt;&gt;({
    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;threshold&#x27;</span>,
    <span class="hljs-attr">elementCode</span>: initialCondition?.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;threshold&#x27;</span> ? initialCondition.<span class="hljs-property">elementCode</span> : <span class="hljs-string">&#x27;&#x27;</span>,
    <span class="hljs-attr">operator</span>: initialCondition?.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;threshold&#x27;</span> ? initialCondition.<span class="hljs-property">operator</span> : <span class="hljs-string">&#x27;&gt;=&#x27;</span>,
    <span class="hljs-attr">value</span>: initialCondition?.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;threshold&#x27;</span> ? initialCondition.<span class="hljs-property">value</span> : <span class="hljs-number">0</span>,
  });
  
  <span class="hljs-keyword">const</span> [compositeCondition, setCompositeCondition] = useState&lt;<span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">CompositeCondition</span>&gt;&gt;({
    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;composite&#x27;</span>,
    <span class="hljs-attr">operator</span>: initialCondition?.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;composite&#x27;</span> ? initialCondition.<span class="hljs-property">operator</span> : <span class="hljs-string">&#x27;AND&#x27;</span>,
    <span class="hljs-attr">conditions</span>: initialCondition?.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;composite&#x27;</span> ? initialCondition.<span class="hljs-property">conditions</span> : [],
  });
  
  <span class="hljs-keyword">const</span> [subConditions, setSubConditions] = useState&lt;<span class="hljs-title class_">Condition</span>[]&gt;(
    initialCondition?.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;composite&#x27;</span> ? initialCondition.<span class="hljs-property">conditions</span> : []
  );
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleThresholdChange</span> = (<span class="hljs-params">field: keyof ThresholdCondition, value: any</span>) =&gt; {
    <span class="hljs-keyword">const</span> updated = { ...thresholdCondition, [field]: value };
    <span class="hljs-title function_">setThresholdCondition</span>(updated);
    
    <span class="hljs-keyword">if</span> (updated.<span class="hljs-property">elementCode</span> &amp;&amp; updated.<span class="hljs-property">operator</span> &amp;&amp; updated.<span class="hljs-property">value</span> !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-title function_">onChange</span>(updated <span class="hljs-keyword">as</span> <span class="hljs-title class_">ThresholdCondition</span>);
    }
  };
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleCompositeOperatorChange</span> = (<span class="hljs-params">operator: <span class="hljs-string">&#x27;AND&#x27;</span> | <span class="hljs-string">&#x27;OR&#x27;</span></span>) =&gt; {
    <span class="hljs-keyword">const</span> updated = { ...compositeCondition, operator };
    <span class="hljs-title function_">setCompositeCondition</span>(updated);
    
    <span class="hljs-keyword">if</span> (subConditions.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-title function_">onChange</span>({ ...updated, <span class="hljs-attr">conditions</span>: subConditions } <span class="hljs-keyword">as</span> <span class="hljs-title class_">CompositeCondition</span>);
    }
  };
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleAddSubCondition</span> = (<span class="hljs-params">condition: Condition</span>) =&gt; {
    <span class="hljs-keyword">const</span> updated = [...subConditions, condition];
    <span class="hljs-title function_">setSubConditions</span>(updated);
    
    <span class="hljs-title function_">onChange</span>({
      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;composite&#x27;</span>,
      <span class="hljs-attr">operator</span>: compositeCondition.<span class="hljs-property">operator</span>,
      <span class="hljs-attr">conditions</span>: updated,
    } <span class="hljs-keyword">as</span> <span class="hljs-title class_">CompositeCondition</span>);
  };
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRemoveSubCondition</span> = (<span class="hljs-params">index: number</span>) =&gt; {
    <span class="hljs-keyword">const</span> updated = subConditions.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> i !== index);
    <span class="hljs-title function_">setSubConditions</span>(updated);
    
    <span class="hljs-keyword">if</span> (updated.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-title function_">onChange</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;composite&#x27;</span>,
        <span class="hljs-attr">operator</span>: compositeCondition.<span class="hljs-property">operator</span>,
        <span class="hljs-attr">conditions</span>: updated,
      } <span class="hljs-keyword">as</span> <span class="hljs-title class_">CompositeCondition</span>);
    }
  };
  
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-4&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;block text-sm font-medium mb-1&quot;</span>&gt;</span>Condition Type<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Select</span>
          <span class="hljs-attr">value</span>=<span class="hljs-string">{conditionType}</span>
          <span class="hljs-attr">onValueChange</span>=<span class="hljs-string">{(value:</span> &#x27;<span class="hljs-attr">threshold</span>&#x27; | &#x27;<span class="hljs-attr">composite</span>&#x27;) =&gt;</span> setConditionType(value)}
        &gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">SelectTrigger</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">SelectValue</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;Select condition type&quot;</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">SelectTrigger</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">SelectContent</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">SelectItem</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;threshold&quot;</span>&gt;</span>Threshold (Simple)<span class="hljs-tag">&lt;/<span class="hljs-name">SelectItem</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">SelectItem</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;composite&quot;</span>&gt;</span>Composite (AND/OR)<span class="hljs-tag">&lt;/<span class="hljs-name">SelectItem</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">SelectContent</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Select</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      {conditionType === &#x27;threshold&#x27; ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-4&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;block text-sm font-medium mb-1&quot;</span>&gt;</span>Score Element<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Select</span>
              <span class="hljs-attr">value</span>=<span class="hljs-string">{thresholdCondition.elementCode}</span>
              <span class="hljs-attr">onValueChange</span>=<span class="hljs-string">{(value)</span> =&gt;</span> handleThresholdChange(&#x27;elementCode&#x27;, value)}
            &gt;
              <span class="hljs-tag">&lt;<span class="hljs-name">SelectTrigger</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">SelectValue</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;Select score element&quot;</span> /&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">SelectTrigger</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">SelectContent</span>&gt;</span>
                {scoreElements.map((element) =&gt; (
                  <span class="hljs-tag">&lt;<span class="hljs-name">SelectItem</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{element.code}</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{element.code!}</span>&gt;</span>
                    {element.name}
                  <span class="hljs-tag">&lt;/<span class="hljs-name">SelectItem</span>&gt;</span>
                ))}
              <span class="hljs-tag">&lt;/<span class="hljs-name">SelectContent</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Select</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;block text-sm font-medium mb-1&quot;</span>&gt;</span>Operator<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Select</span>
              <span class="hljs-attr">value</span>=<span class="hljs-string">{thresholdCondition.operator}</span>
              <span class="hljs-attr">onValueChange</span>=<span class="hljs-string">{(value)</span> =&gt;</span> handleThresholdChange(&#x27;operator&#x27;, value)}
            &gt;
              <span class="hljs-tag">&lt;<span class="hljs-name">SelectTrigger</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">SelectValue</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;Select operator&quot;</span> /&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">SelectTrigger</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">SelectContent</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">SelectItem</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;==&quot;</span>&gt;</span>Equal to (==)<span class="hljs-tag">&lt;/<span class="hljs-name">SelectItem</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">SelectItem</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;!=&quot;</span>&gt;</span>Not equal to (!=)<span class="hljs-tag">&lt;/<span class="hljs-name">SelectItem</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">SelectItem</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&gt;&quot;</span>&gt;</span>Greater than (&gt;)<span class="hljs-tag">&lt;/<span class="hljs-name">SelectItem</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">SelectItem</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&gt;=&quot;</span>&gt;</span>Greater than or equal to (&gt;=)<span class="hljs-tag">&lt;/<span class="hljs-name">SelectItem</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">SelectItem</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&lt;&quot;</span>&gt;</span>Less than (&lt;)<span class="hljs-tag">&lt;/<span class="hljs-name">SelectItem</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">SelectItem</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&lt;=&quot;</span>&gt;</span>Less than or equal to (&lt;=)<span class="hljs-tag">&lt;/<span class="hljs-name">SelectItem</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">SelectContent</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Select</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;block text-sm font-medium mb-1&quot;</span>&gt;</span>Value<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Input</span>
              <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;number&quot;</span>
              <span class="hljs-attr">value</span>=<span class="hljs-string">{thresholdCondition.value}</span>
              <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> handleThresholdChange(&#x27;value&#x27;, parseInt(e.target.value))}
            /&gt;
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ) : (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-4&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;block text-sm font-medium mb-1&quot;</span>&gt;</span>Composite Operator<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Select</span>
              <span class="hljs-attr">value</span>=<span class="hljs-string">{compositeCondition.operator}</span>
              <span class="hljs-attr">onValueChange</span>=<span class="hljs-string">{(value:</span> &#x27;<span class="hljs-attr">AND</span>&#x27; | &#x27;<span class="hljs-attr">OR</span>&#x27;) =&gt;</span> handleCompositeOperatorChange(value)}
            &gt;
              <span class="hljs-tag">&lt;<span class="hljs-name">SelectTrigger</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">SelectValue</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;Select operator&quot;</span> /&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">SelectTrigger</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">SelectContent</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">SelectItem</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;AND&quot;</span>&gt;</span>AND (All conditions must be true)<span class="hljs-tag">&lt;/<span class="hljs-name">SelectItem</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">SelectItem</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;OR&quot;</span>&gt;</span>OR (Any condition must be true)<span class="hljs-tag">&lt;/<span class="hljs-name">SelectItem</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">SelectContent</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Select</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-2&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;block text-sm font-medium&quot;</span>&gt;</span>Sub-Conditions<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            
            {subConditions.map((condition, index) =&gt; (
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-3 border rounded-md&quot;</span>&gt;</span>
                {condition.type === &#x27;threshold&#x27; ? (
                  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex justify-between items-center&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>
                      {scoreElements.find(e =&gt; e.code === condition.elementCode)?.name} 
                      {&#x27; &#x27;}{condition.operator}{&#x27; &#x27;}
                      {condition.value}
                    <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> 
                      <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;sm&quot;</span> 
                      <span class="hljs-attr">variant</span>=<span class="hljs-string">&quot;destructive&quot;</span>
                      <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleRemoveSubCondition(index)}
                    &gt;
                      Remove
                    <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
                  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                ) : (
                  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex justify-between items-center&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>Composite {condition.operator} condition<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> 
                      <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;sm&quot;</span> 
                      <span class="hljs-attr">variant</span>=<span class="hljs-string">&quot;destructive&quot;</span>
                      <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleRemoveSubCondition(index)}
                    &gt;
                      Remove
                    <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
                  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                )}
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            ))}
            
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;border border-dashed p-4 rounded-md&quot;</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">h4</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-medium mb-2&quot;</span>&gt;</span>Add Sub-Condition<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">ConditionBuilder</span> 
                <span class="hljs-attr">scoreElements</span>=<span class="hljs-string">{scoreElements}</span>
                <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleAddSubCondition}</span>
              /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h4 id="dynamicscoreinput-component">DynamicScoreInput Component</h4>
<pre><code class="language-tsx"><span class="hljs-comment">// components/scoring/DynamicScoreInput.tsx</span>
<span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Card</span>, <span class="hljs-title class_">Button</span>, <span class="hljs-title class_">Counter</span>, <span class="hljs-title class_">Checkbox</span>, <span class="hljs-title class_">Alert</span>, <span class="hljs-title class_">AlertTitle</span>, <span class="hljs-title class_">AlertDescription</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/ui&#x27;</span>;
<span class="hljs-keyword">import</span> { useScoreConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/hooks/tanstack-query/useScoreConfig&#x27;</span>;
<span class="hljs-keyword">import</span> { useMatchScore } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/hooks/tanstack-query/useMatchScore&#x27;</span>;
<span class="hljs-keyword">import</span> { useSubmitScore } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/hooks/tanstack-query/useSubmitScore&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ScoreElement</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/types/score-config&#x27;</span>;

interface <span class="hljs-title class_">DynamicScoreInputProps</span> {
  <span class="hljs-attr">tournamentId</span>: string;
  <span class="hljs-attr">matchId</span>: string;
  <span class="hljs-attr">allianceId</span>: string;
  <span class="hljs-attr">allianceColor</span>: string;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">DynamicScoreInput</span> = (<span class="hljs-params">{ 
  tournamentId, 
  matchId, 
  allianceId,
  allianceColor
}: DynamicScoreInputProps</span>) =&gt; {
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: scoreConfig, <span class="hljs-attr">isLoading</span>: configLoading } = <span class="hljs-title function_">useScoreConfig</span>(tournamentId);
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: existingScore } = <span class="hljs-title function_">useMatchScore</span>(matchId, allianceId);
  <span class="hljs-keyword">const</span> submitMutation = <span class="hljs-title function_">useSubmitScore</span>(matchId, allianceId);
  
  <span class="hljs-keyword">const</span> [elementScores, setElementScores] = useState&lt;<span class="hljs-title class_">Record</span>&lt;string, number&gt;&gt;({});
  <span class="hljs-keyword">const</span> [calculatedScore, setCalculatedScore] = useState&lt;number | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  
  <span class="hljs-comment">// Initialize scores from existing data or defaults</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (scoreConfig?.<span class="hljs-property">scoreElements</span>) {
      <span class="hljs-keyword">const</span> <span class="hljs-attr">initialScores</span>: <span class="hljs-title class_">Record</span>&lt;string, number&gt; = {};
      
      <span class="hljs-comment">// Start with zeros for all elements</span>
      scoreConfig.<span class="hljs-property">scoreElements</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">element</span> =&gt;</span> {
        initialScores[element.<span class="hljs-property">code</span>] = <span class="hljs-number">0</span>;
      });
      
      <span class="hljs-comment">// Override with existing scores if available</span>
      <span class="hljs-keyword">if</span> (existingScore?.<span class="hljs-property">elementScores</span>) {
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(initialScores, existingScore.<span class="hljs-property">elementScores</span>);
      }
      
      <span class="hljs-title function_">setElementScores</span>(initialScores);
      <span class="hljs-title function_">setCalculatedScore</span>(existingScore?.<span class="hljs-property">totalScore</span> || <span class="hljs-literal">null</span>);
    }
  }, [scoreConfig, existingScore]);
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">code: string, value: number</span>) =&gt; {
    <span class="hljs-title function_">setElementScores</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({ ...prev, [code]: value }));
    <span class="hljs-comment">// Reset calculated score when user makes changes</span>
    <span class="hljs-title function_">setCalculatedScore</span>(<span class="hljs-literal">null</span>);
  };
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> submitMutation.<span class="hljs-title function_">mutateAsync</span>({
        elementScores,
        <span class="hljs-attr">scoreConfigId</span>: scoreConfig?.<span class="hljs-property">id</span>,
      });
      
      <span class="hljs-title function_">setCalculatedScore</span>(result.<span class="hljs-property">totalScore</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Error submitting scores:&#x27;</span>, error);
    }
  };
  
  <span class="hljs-keyword">if</span> (configLoading) <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Loading score configuration...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  <span class="hljs-keyword">if</span> (!scoreConfig) <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>No score configuration found for this tournament<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  
  <span class="hljs-comment">// Group elements by category</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">elementsByCategory</span>: <span class="hljs-title class_">Record</span>&lt;string, <span class="hljs-title class_">ScoreElement</span>[]&gt; = {};
  scoreConfig.<span class="hljs-property">scoreElements</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">element</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> category = element.<span class="hljs-property">category</span> || <span class="hljs-string">&#x27;Uncategorized&#x27;</span>;
    <span class="hljs-keyword">if</span> (!elementsByCategory[category]) {
      elementsByCategory[category] = [];
    }
    elementsByCategory[category].<span class="hljs-title function_">push</span>(element);
  });
  
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-6&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Card</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-6&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-2xl font-bold mb-4&quot;</span>&gt;</span>
          Score Input - {allianceColor} Alliance
        <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        
        {Object.entries(elementsByCategory).map(([category, elements]) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{category}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mb-6&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-lg font-semibold mb-3&quot;</span>&gt;</span>{category}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-4&quot;</span>&gt;</span>
              {elements
                .sort((a, b) =&gt; a.displayOrder - b.displayOrder)
                .map(element =&gt; (
                  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{element.id}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex items-center justify-between p-3 border rounded-md&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-medium&quot;</span>&gt;</span>{element.name}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-sm text-gray-500&quot;</span>&gt;</span>
                        {element.pointsPerUnit &gt; 0 ? &#x27;+&#x27; : &#x27;&#x27;}{element.pointsPerUnit} points each
                      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    
                    {element.elementType === &#x27;counter&#x27; ? (
                      <span class="hljs-tag">&lt;<span class="hljs-name">Counter</span>
                        <span class="hljs-attr">value</span>=<span class="hljs-string">{elementScores[element.code]</span> || <span class="hljs-attr">0</span>}
                        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(value)</span> =&gt;</span> handleChange(element.code, value)}
                        min={0}
                        max={element.maxUnits || undefined}
                      /&gt;
                    ) : (
                      <span class="hljs-tag">&lt;<span class="hljs-name">Checkbox</span>
                        <span class="hljs-attr">checked</span>=<span class="hljs-string">{!!elementScores[element.code]}</span>
                        <span class="hljs-attr">onCheckedChange</span>=<span class="hljs-string">{(checked)</span> =&gt;</span> handleChange(element.code, checked ? 1 : 0)}
                      /&gt;
                    )}
                  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                ))}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ))}
        
        {calculatedScore !== null &amp;&amp; (
          <span class="hljs-tag">&lt;<span class="hljs-name">Alert</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mt-4&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">AlertTitle</span>&gt;</span>Score Calculated<span class="hljs-tag">&lt;/<span class="hljs-name">AlertTitle</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">AlertDescription</span>&gt;</span>
              Total score: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-bold&quot;</span>&gt;</span>{calculatedScore}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> points
            <span class="hljs-tag">&lt;/<span class="hljs-name">AlertDescription</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">Alert</span>&gt;</span>
        )}
        
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mt-6 flex justify-end&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> 
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleSubmit}</span>
            <span class="hljs-attr">disabled</span>=<span class="hljs-string">{submitMutation.isPending}</span>
          &gt;</span>
            {submitMutation.isPending ? &#x27;Submitting...&#x27; : &#x27;Submit Scores&#x27;}
          <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h4 id="scoredisplay-component">ScoreDisplay Component</h4>
<pre><code class="language-tsx"><span class="hljs-comment">// components/scoring/ScoreDisplay.tsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Card</span>, <span class="hljs-title class_">Table</span>, <span class="hljs-title class_">TableBody</span>, <span class="hljs-title class_">TableCell</span>, <span class="hljs-title class_">TableHead</span>, <span class="hljs-title class_">TableHeader</span>, <span class="hljs-title class_">TableRow</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/ui&#x27;</span>;
<span class="hljs-keyword">import</span> { useMatchScore } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/hooks/tanstack-query/useMatchScore&#x27;</span>;

interface <span class="hljs-title class_">ScoreDisplayProps</span> {
  <span class="hljs-attr">matchId</span>: string;
  <span class="hljs-attr">allianceId</span>: string;
  <span class="hljs-attr">allianceColor</span>: string;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">ScoreDisplay</span> = (<span class="hljs-params">{ 
  matchId, 
  allianceId,
  allianceColor
}: ScoreDisplayProps</span>) =&gt; {
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: matchScore, isLoading } = <span class="hljs-title function_">useMatchScore</span>(matchId, allianceId);
  
  <span class="hljs-keyword">if</span> (isLoading) <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Loading scores...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  <span class="hljs-keyword">if</span> (!matchScore) <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>No score data available<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  
  <span class="hljs-keyword">const</span> { scoreConfig, elementScores, bonusesEarned, penaltiesIncurred, calculationLog, totalScore } = matchScore;
  
  <span class="hljs-keyword">if</span> (!scoreConfig) <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Score configuration not found<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Card</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-6&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-2xl font-bold mb-4&quot;</span>&gt;</span>
        {allianceColor} Alliance Score: {totalScore}
      <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-6&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-lg font-semibold mb-3&quot;</span>&gt;</span>Score Elements<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Table</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">TableHeader</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">TableRow</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">TableHead</span>&gt;</span>Element<span class="hljs-tag">&lt;/<span class="hljs-name">TableHead</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">TableHead</span>&gt;</span>Count<span class="hljs-tag">&lt;/<span class="hljs-name">TableHead</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">TableHead</span>&gt;</span>Points Each<span class="hljs-tag">&lt;/<span class="hljs-name">TableHead</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">TableHead</span>&gt;</span>Total<span class="hljs-tag">&lt;/<span class="hljs-name">TableHead</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">TableRow</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">TableHeader</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">TableBody</span>&gt;</span>
              {scoreConfig.scoreElements.map(element =&gt; {
                const count = elementScores[element.code] || 0;
                const points = count * element.pointsPerUnit;
                
                return (
                  <span class="hljs-tag">&lt;<span class="hljs-name">TableRow</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{element.id}</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">TableCell</span>&gt;</span>{element.name}<span class="hljs-tag">&lt;/<span class="hljs-name">TableCell</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">TableCell</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">TableCell</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">TableCell</span>&gt;</span>{element.pointsPerUnit}<span class="hljs-tag">&lt;/<span class="hljs-name">TableCell</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">TableCell</span>&gt;</span>{points}<span class="hljs-tag">&lt;/<span class="hljs-name">TableCell</span>&gt;</span>
                  <span class="hljs-tag">&lt;/<span class="hljs-name">TableRow</span>&gt;</span>
                );
              })}
            <span class="hljs-tag">&lt;/<span class="hljs-name">TableBody</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">Table</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        
        {bonusesEarned.length &gt; 0 &amp;&amp; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-lg font-semibold mb-3&quot;</span>&gt;</span>Bonuses<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Table</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">TableHeader</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">TableRow</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">TableHead</span>&gt;</span>Bonus<span class="hljs-tag">&lt;/<span class="hljs-name">TableHead</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">TableHead</span>&gt;</span>Points<span class="hljs-tag">&lt;/<span class="hljs-name">TableHead</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">TableRow</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">TableHeader</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">TableBody</span>&gt;</span>
                {bonusesEarned.map(bonusId =&gt; {
                  const bonus = scoreConfig.bonusConditions.find(b =&gt; b.id === bonusId);
                  if (!bonus) return null;
                  
                  return (
                    <span class="hljs-tag">&lt;<span class="hljs-name">TableRow</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{bonus.id}</span>&gt;</span>
                      <span class="hljs-tag">&lt;<span class="hljs-name">TableCell</span>&gt;</span>{bonus.name}<span class="hljs-tag">&lt;/<span class="hljs-name">TableCell</span>&gt;</span>
                      <span class="hljs-tag">&lt;<span class="hljs-name">TableCell</span>&gt;</span>+{bonus.bonusPoints}<span class="hljs-tag">&lt;/<span class="hljs-name">TableCell</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">TableRow</span>&gt;</span>
                  );
                })}
              <span class="hljs-tag">&lt;/<span class="hljs-name">TableBody</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Table</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        )}
        
        {penaltiesIncurred.length &gt; 0 &amp;&amp; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-lg font-semibold mb-3&quot;</span>&gt;</span>Penalties<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Table</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">TableHeader</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">TableRow</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">TableHead</span>&gt;</span>Penalty<span class="hljs-tag">&lt;/<span class="hljs-name">TableHead</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">TableHead</span>&gt;</span>Points<span class="hljs-tag">&lt;/<span class="hljs-name">TableHead</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">TableRow</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">TableHeader</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">TableBody</span>&gt;</span>
                {penaltiesIncurred.map(penaltyId =&gt; {
                  const penalty = scoreConfig.penaltyConditions.find(p =&gt; p.id === penaltyId);
                  if (!penalty) return null;
                  
                  return (
                    <span class="hljs-tag">&lt;<span class="hljs-name">TableRow</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{penalty.id}</span>&gt;</span>
                      <span class="hljs-tag">&lt;<span class="hljs-name">TableCell</span>&gt;</span>{penalty.name}<span class="hljs-tag">&lt;/<span class="hljs-name">TableCell</span>&gt;</span>
                      <span class="hljs-tag">&lt;<span class="hljs-name">TableCell</span>&gt;</span>{penalty.penaltyPoints}<span class="hljs-tag">&lt;/<span class="hljs-name">TableCell</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">TableRow</span>&gt;</span>
                  );
                })}
              <span class="hljs-tag">&lt;/<span class="hljs-name">TableBody</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Table</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        )}
        
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mt-4 p-4 bg-gray-100 rounded-md&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-bold&quot;</span>&gt;</span>Total Score: {totalScore}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span></span>
  );
};
</code></pre>
<h3 id="35-pages">3.5 Pages</h3>
<h4 id="admin-score-config-page">Admin Score Config Page</h4>
<pre><code class="language-tsx"><span class="hljs-comment">// app/admin/tournaments/[tournamentId]/score-config/page.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { useParams, useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/navigation&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span>, <span class="hljs-title class_">Card</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/ui&#x27;</span>;
<span class="hljs-keyword">import</span> { useScoreConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/hooks/tanstack-query/useScoreConfig&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ScoreConfigPage</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> params = <span class="hljs-title function_">useParams</span>();
  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
  <span class="hljs-keyword">const</span> tournamentId = params.<span class="hljs-property">tournamentId</span> <span class="hljs-keyword">as</span> string;
  
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: scoreConfig, isLoading } = <span class="hljs-title function_">useScoreConfig</span>(tournamentId);
  
  <span class="hljs-keyword">if</span> (isLoading) {
    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Loading score configuration...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
  
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-6&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;flex justify-between items-center&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-3xl font-bold&quot;</span>&gt;</span>Score Configuration<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        
        {!scoreConfig &amp;&amp; (
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> 
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> router.push(`/admin/tournaments/${tournamentId}/score-config/create`)}
          &gt;
            Create Score Configuration
          <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        )}
        
        {scoreConfig &amp;&amp; (
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> 
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> router.push(`/admin/tournaments/${tournamentId}/score-config/${scoreConfig.id}/edit`)}
          &gt;
            Edit Configuration
          <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        )}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      {scoreConfig ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-6&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Card</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-6&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-2xl font-bold mb-4&quot;</span>&gt;</span>{scoreConfig.name}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
            {scoreConfig.description &amp;&amp; (
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-gray-600 mb-4&quot;</span>&gt;</span>{scoreConfig.description}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            )}
          <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span>
          
          <span class="hljs-tag">&lt;<span class="hljs-name">Card</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-6&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-bold mb-4&quot;</span>&gt;</span>Score Elements<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;grid grid-cols-1 md:grid-cols-2 gap-4&quot;</span>&gt;</span>
              {scoreConfig.scoreElements.map(element =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{element.id}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-4 border rounded-md&quot;</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-semibold&quot;</span>&gt;</span>{element.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-sm text-gray-600&quot;</span>&gt;</span>{element.description}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mt-2&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-medium&quot;</span>&gt;</span>
                      {element.pointsPerUnit &gt; 0 ? &#x27;+&#x27; : &#x27;&#x27;}{element.pointsPerUnit} points
                    <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                    {&#x27; &#x27;}per {element.elementType === &#x27;boolean&#x27; ? &#x27;yes&#x27; : &#x27;unit&#x27;}
                  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                  {element.maxUnits &amp;&amp; (
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-sm text-gray-600&quot;</span>&gt;</span>
                      Maximum: {element.maxUnits} units
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                  )}
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              ))}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span>
          
          {scoreConfig.bonusConditions.length &gt; 0 &amp;&amp; (
            <span class="hljs-tag">&lt;<span class="hljs-name">Card</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-6&quot;</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-bold mb-4&quot;</span>&gt;</span>Bonus Conditions<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-4&quot;</span>&gt;</span>
                {scoreConfig.bonusConditions.map(bonus =&gt; (
                  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{bonus.id}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-4 border rounded-md&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-semibold&quot;</span>&gt;</span>{bonus.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-sm text-gray-600&quot;</span>&gt;</span>{bonus.description}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mt-2&quot;</span>&gt;</span>
                      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-medium&quot;</span>&gt;</span>+{bonus.bonusPoints} points<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                      {&#x27; &#x27;}when condition is met
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                ))}
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span>
          )}
          
          {scoreConfig.penaltyConditions.length &gt; 0 &amp;&amp; (
            <span class="hljs-tag">&lt;<span class="hljs-name">Card</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-6&quot;</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-bold mb-4&quot;</span>&gt;</span>Penalty Conditions<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-4&quot;</span>&gt;</span>
                {scoreConfig.penaltyConditions.map(penalty =&gt; (
                  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{penalty.id}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-4 border rounded-md&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-semibold&quot;</span>&gt;</span>{penalty.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-sm text-gray-600&quot;</span>&gt;</span>{penalty.description}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;mt-2&quot;</span>&gt;</span>
                      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;font-medium&quot;</span>&gt;</span>{penalty.penaltyPoints} points<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                      {&#x27; &#x27;}when condition is met
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                ))}
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span>
          )}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ) : (
        <span class="hljs-tag">&lt;<span class="hljs-name">Card</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;p-6&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-center py-8&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl font-semibold mb-2&quot;</span>&gt;</span>No Score Configuration<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-gray-600 mb-4&quot;</span>&gt;</span>
              This tournament doesn&#x27;t have a score configuration yet.
            <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> 
              <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> router.push(`/admin/tournaments/${tournamentId}/score-config/create`)}
            &gt;
              Create Score Configuration
            <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 id="referee-scoring-page">Referee Scoring Page</h4>
<pre><code class="language-tsx"><span class="hljs-comment">// app/referee/matches/[matchId]/scoring/page.tsx</span>
<span class="hljs-string">&#x27;use client&#x27;</span>;

<span class="hljs-keyword">import</span> { useParams } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/navigation&#x27;</span>;
<span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Tabs</span>, <span class="hljs-title class_">TabsContent</span>, <span class="hljs-title class_">TabsList</span>, <span class="hljs-title class_">TabsTrigger</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/ui&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DynamicScoreInput</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/scoring/DynamicScoreInput&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ScoreDisplay</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/scoring/ScoreDisplay&#x27;</span>;
<span class="hljs-keyword">import</span> { useMatch } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/hooks/tanstack-query/useMatch&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MatchScoringPage</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> params = <span class="hljs-title function_">useParams</span>();
  <span class="hljs-keyword">const</span> matchId = params.<span class="hljs-property">matchId</span> <span class="hljs-keyword">as</span> string;
  
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: match, isLoading } = <span class="hljs-title function_">useMatch</span>(matchId);
  <span class="hljs-keyword">const</span> [tournamentId, setTournamentId] = useState&lt;string | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (match?.<span class="hljs-property">stage</span>?.<span class="hljs-property">tournamentId</span>) {
      <span class="hljs-title function_">setTournamentId</span>(match.<span class="hljs-property">stage</span>.<span class="hljs-property">tournamentId</span>);
    }
  }, [match]);
  
  <span class="hljs-keyword">if</span> (isLoading) {
    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Loading match data...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
  
  <span class="hljs-keyword">if</span> (!match) {
    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Match not found<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
  
  <span class="hljs-keyword">if</span> (!tournamentId) {
    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Tournament information not available<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
  
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;space-y-6&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-3xl font-bold&quot;</span>&gt;</span>Match Scoring<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;text-xl&quot;</span>&gt;</span>Match #{match.matchNumber}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">Tabs</span> <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">&quot;input&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">TabsList</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">TabsTrigger</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;input&quot;</span>&gt;</span>Score Input<span class="hljs-tag">&lt;/<span class="hljs-name">TabsTrigger</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">TabsTrigger</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;display&quot;</span>&gt;</span>Score Display<span class="hljs-tag">&lt;/<span class="hljs-name">TabsTrigger</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">TabsList</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">TabsContent</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;input&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;grid grid-cols-1 md:grid-cols-2 gap-6&quot;</span>&gt;</span>
            {match.alliances.map(alliance =&gt; (
              <span class="hljs-tag">&lt;<span class="hljs-name">DynamicScoreInput</span>
                <span class="hljs-attr">key</span>=<span class="hljs-string">{alliance.id}</span>
                <span class="hljs-attr">tournamentId</span>=<span class="hljs-string">{tournamentId}</span>
                <span class="hljs-attr">matchId</span>=<span class="hljs-string">{matchId}</span>
                <span class="hljs-attr">allianceId</span>=<span class="hljs-string">{alliance.id}</span>
                <span class="hljs-attr">allianceColor</span>=<span class="hljs-string">{alliance.color}</span>
              /&gt;</span>
            ))}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">TabsContent</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">TabsContent</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;display&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;grid grid-cols-1 md:grid-cols-2 gap-6&quot;</span>&gt;</span>
            {match.alliances.map(alliance =&gt; (
              <span class="hljs-tag">&lt;<span class="hljs-name">ScoreDisplay</span>
                <span class="hljs-attr">key</span>=<span class="hljs-string">{alliance.id}</span>
                <span class="hljs-attr">matchId</span>=<span class="hljs-string">{matchId}</span>
                <span class="hljs-attr">allianceId</span>=<span class="hljs-string">{alliance.id}</span>
                <span class="hljs-attr">allianceColor</span>=<span class="hljs-string">{alliance.color}</span>
              /&gt;</span>
            ))}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">TabsContent</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Tabs</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h2 id="4-complete-prisma-schema">4. Complete Prisma Schema</h2>
<pre><code class="language-prisma">// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = &quot;prisma-client-js&quot;
  output   = &quot;../generated/prisma&quot;
}

datasource db {
  provider = &quot;postgresql&quot;
  url      = env(&quot;DATABASE_URL&quot;)
}

enum UserRole {
  ADMIN
  HEAD_REFEREE
  ALLIANCE_REFEREE
  COMMON
}

enum StageType {
  SWISS
  PLAYOFF
  FINAL
}

enum CardType {
  NONE
  YELLOW
  RED
}

enum RefereeRole {
  HEAD_REFEREE
  ALLIANCE_REFEREE
}

enum MatchState {
  SCHEDULED
  READY
  RUNNING
  PAUSED
  COMPLETED
  CANCELLED
  ERROR
}

enum ErrorSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ErrorStatus {
  OPEN
  ACKNOWLEDGED
  RESOLVED
  CLOSED
}

enum DisplayState {
  STANDBY
  STARTING_SOON
  LIVE
  MATCH_RESULTS
  FINISHED
  CANCELLED
  ERROR
  CUSTOM_MESSAGE
}

enum MatchType {
  FULL         // auto + teleop + endgame (150s)
  TELEOP_ENDGAME // teleop + endgame (120s)
}

model User {
  id              String           @id @default(uuid())
  username        String           @unique
  password        String
  role            UserRole
  email           String?          @unique
  gender          Boolean?
  DateOfBirth     DateTime?
  phoneNumber     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  createdBy       User?            @relation(&quot;CreatedUsers&quot;, fields: [createdById], references: [id])
  createdById     String?
  createdUsers    User[]           @relation(&quot;CreatedUsers&quot;)
  tournaments     Tournament[]
  scoredMatches   Match[]          @relation(&quot;ScoredBy&quot;)
  allianceRefFor  AllianceScoring[] @relation(&quot;AllianceReferee&quot;)
  matchReferees   MatchReferee[]   // New relation for match referees
}

model Tournament {
  id              String        @id @default(uuid())
  name            String
  description     String?
  startDate       DateTime
  endDate         DateTime
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  adminId         String
  admin           User          @relation(fields: [adminId], references: [id])
  stages          Stage[]
  teams           Team[]        // Added teams relationship
  teamStats       TeamStats[]   // New relation to track team statistics
  fields          Field[]       // New relation: Tournament has many Fields
  numberOfFields  Int           @default(1)
  scoreConfigs    ScoreConfig[] // New relation: Tournament has many ScoreConfigs
}

model Stage {
  id           String    @id @default(uuid())
  name         String
  type         StageType
  startDate    DateTime
  endDate      DateTime
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  matches      Match[]
  teamStats    TeamStats[] // Added relation field for TeamStats
  teamsPerAlliance Int @default(2) // Number of teams per alliance (2v2, 3v3, etc.)
  teamsPerMatch    Int @default(4) // Number of teams per match (all alliances)
  schedules        Schedule[] // Add this line for relation
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Match {
  id            String    @id @default(uuid())
  matchNumber   Int
  roundNumber   Int?      // The round number this match belongs to
  status        String    @default(&quot;PENDING&quot;) // PENDING, IN_PROGRESS, COMPLETED
  startTime     DateTime? // Full timestamp with hour-minute precision
  scheduledTime DateTime? // New field for the scheduled time with hour-minute precision
  endTime       DateTime? // Full timestamp with hour-minute precision
  duration      Int?      // Duration in minutes
  winningAlliance String?  // &quot;RED&quot; or &quot;BLUE&quot; - indicates which alliance won
  stageId       String
  stage         Stage     @relation(fields: [stageId], references: [id], onDelete: Cascade)
  alliances     Alliance[]
  scoredById    String?
  scoredBy      User?     @relation(&quot;ScoredBy&quot;, fields: [scoredById], references: [id])
  referees      MatchReferee[] // New relation for match referees
  matchScores   MatchScores?
  matchControl  MatchControl? // Optional relation to match control for display state
  roundType     String? // e.g., &quot;QUALIFICATION&quot;, &quot;SWISS&quot;, &quot;PLAYOFF&quot;, &quot;FINAL&quot;
  scheduleId    String?
  schedule      Schedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)
  fieldId       String?
  field         Field?     @relation(fields: [fieldId], references: [id], onDelete: SetNull)
  fieldNumber   Int?
  matchType     MatchType  @default(FULL) // Type of match: FULL, TELEOP_ENDGAME
  matchDuration Int?       // Duration of the match in seconds (overrides default if set)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  matchScoreRecords MatchScore[] // New relation to flexible match scores
}

model MatchReferee {
  id        String      @id @default(uuid())
  matchId   String
  match     Match       @relation(fields: [matchId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation(fields: [userId], references: [id])
  role      RefereeRole // HEAD_REFEREE or ALLIANCE_REFEREE
  position  String?     // Optional position identifier (e.g. &quot;RED1&quot;, &quot;BLUE2&quot;)
  createdAt DateTime    @default(now()) 
  updatedAt DateTime    @updatedAt

  @@unique([matchId, userId])
  @@index([matchId])
  @@index([userId])
}

model Alliance {
  id            String    @id @default(uuid())
  color         String    // e.g., &quot;RED&quot;, &quot;BLUE&quot;
  score         Int       @default(0)
  matchId       String
  match         Match     @relation(fields: [matchId], references: [id], onDelete: Cascade)
  teamAlliances TeamAlliance[]
  allianceScoring AllianceScoring?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  matchScores   MatchScore[] // New relation to flexible match scores
}

model AllianceScoring {
  id            String    @id @default(uuid())
  allianceId    String    @unique
  alliance      Alliance  @relation(fields: [allianceId], references: [id], onDelete: Cascade)
  refereeId     String?
  referee       User?     @relation(&quot;AllianceReferee&quot;, fields: [refereeId], references: [id])
  scoreDetails  Json?     // Store detailed scoring information as JSON
  card          CardType  @default(NONE)
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Team {
  id            String         @id @default(uuid())
  teamNumber    String         @unique
  name          String
  organization  String?
  avatar        String?        // URL to team avatar image
  description   String?        // Team description
  teamMembers   Json?          // Store team members as a JSON array
  tournamentId  String?        // Optional link to tournament
  tournament    Tournament?    @relation(fields: [tournamentId], references: [id])
  teamAlliances TeamAlliance[]
  teamStats     TeamStats[]    // New relation to track team statistics
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([tournamentId])
}

model TeamAlliance {
  id          String   @id @default(uuid())
  teamId      String
  team        Team     @relation(fields: [teamId], references: [id])
  allianceId  String
  alliance    Alliance @relation(fields: [allianceId], references: [id], onDelete: Cascade)
  stationPosition Int   @default(1)  // Station position: 1, 2, or 3 within an alliance
  isSurrogate Boolean  @default(false) // Indicates if this is a surrogate appearance
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([teamId, allianceId])
}

model MatchScores {
  id                String   @id @default(uuid())
  matchId           String   @unique
  match             Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)
  
  // Red Alliance Scores
  redAutoScore      Int      @default(0)
  redDriveScore     Int      @default(0)
  redTotalScore     Int      @default(0)
  
  // Blue Alliance Scores
  blueAutoScore     Int      @default(0)
  blueDriveScore    Int      @default(0)
  blueTotalScore    Int      @default(0)
  
  // Game Elements Scoring for Red Alliance
  redGameElements   Json?    // Structure: [{ &quot;element&quot;: &quot;ball&quot;, &quot;count&quot;: 3, &quot;pointsEach&quot;: 20, &quot;totalPoints&quot;: 60, &quot;operation&quot;: &quot;multiply&quot; }]
  
  // Game Elements Scoring for Blue Alliance
  blueGameElements  Json?    // Structure: [{ &quot;element&quot;: &quot;ball&quot;, &quot;count&quot;: 3, &quot;pointsEach&quot;: 20, &quot;totalPoints&quot;: 60, &quot;operation&quot;: &quot;multiply&quot; }]
  
  // Team count multipliers (applied automatically based on team count)
  redTeamCount      Int      @default(0)  // Number of teams in red alliance (1-4)
  redMultiplier     Float    @default(1.0) // Calculated multiplier based on team count: 1 team (x1.25), 2 teams (x1.5), 3 teams (x1.75), 4 teams (x2)
  
  blueTeamCount     Int      @default(0)  // Number of teams in blue alliance (1-4)
  blueMultiplier    Float    @default(1.0) // Calculated multiplier based on team count: 1 team (x1.25), 2 teams (x1.5), 3 teams (x1.75), 4 teams (x2)
  
  // Additional metadata
  scoreDetails      Json?    // Other scoring details or game-specific information
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model TeamStats {
  id                  String   @id @default(uuid())
  teamId              String
  team                Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  tournamentId        String
  tournament          Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  stageId             String?    // Adding optional stageId field for stage-specific stats
  stage               Stage?     @relation(fields: [stageId], references: [id], onDelete: SetNull)
  wins                Int       @default(0)
  losses              Int       @default(0)
  ties                Int       @default(0)
  pointsScored        Int       @default(0)
  pointsConceded      Int       @default(0)
  matchesPlayed       Int       @default(0)
  rankingPoints       Int       @default(0)
  opponentWinPercentage Float   @default(0)
  pointDifferential   Int       @default(0)
  rank                Int?      // For playoff rankings
  tiebreaker1         Float     @default(0) // First tiebreaker metric (e.g., average score)
  tiebreaker2         Float     @default(0) // Second tiebreaker metric (e.g., strength of schedule)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([teamId, tournamentId])
  @@index([teamId])
  @@index([tournamentId])
  @@index([stageId])
}

model Schedule {
  id        String   @id @default(uuid())
  stageId   String
  stage     Stage    @relation(fields: [stageId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  matches   Match[]
  algorithm String?  // e.g., &quot;simulated_annealing&quot;, &quot;swiss&quot;
  quality   String?  // e.g., &quot;low&quot;, &quot;medium&quot;, &quot;high&quot;
  params    Json?    // Store algorithm parameters
}

model Field {
  id           String      @id @default(uuid())
  name         String
  number       Int
  location     String?
  description  String?
  tournamentId String
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  matches      Match[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([tournamentId, number])
}

model MatchControl {
  id              String      @id @default(uuid())
  matchId         String      @unique
  match           Match       @relation(fields: [matchId], references: [id], onDelete: Cascade)
  currentState    MatchState  @default(SCHEDULED)
  stateHistory    Json?       // Array of state transitions with timestamps
  controlledBy    String?     // Admin who is currently controlling the match
  lockToken       String?     // Token for locking control to prevent race conditions
  lockTimestamp   DateTime?   // When the lock was acquired
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  matchTimers     MatchTimer[] 
  matchErrors     MatchError[] 
  audienceDisplay AudienceDisplay?
}

model MatchTimer {
  id              String      @id @default(uuid())
  matchControlId  String
  matchControl    MatchControl @relation(fields: [matchControlId], references: [id], onDelete: Cascade)
  timerType       String      // &quot;AUTO&quot;, &quot;TELEOP&quot;, &quot;ENDGAME&quot;, &quot;FULL_MATCH&quot;, etc.
  duration        Int         // Total duration in seconds
  remaining       Int         // Remaining time in seconds
  isRunning       Boolean     @default(false)
  startedAt       DateTime?   // When the timer was started
  pausedAt        DateTime?   // When the timer was last paused
  completedAt     DateTime?   // When the timer completed
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model MatchError {
  id              String        @id @default(uuid())
  matchControlId  String
  matchControl    MatchControl  @relation(fields: [matchControlId], references: [id], onDelete: Cascade)
  errorType       String        // &quot;ROBOT_FAILURE&quot;, &quot;FIELD_FAULT&quot;, &quot;NETWORK_ISSUE&quot;, etc.
  description     String
  severity        ErrorSeverity @default(MEDIUM)
  status          ErrorStatus   @default(OPEN)
  reportedBy      String        // User ID who reported the error
  resolvedBy      String?       // User ID who resolved the error
  resolvedAt      DateTime?
  affectedAlliance String?      // &quot;RED&quot;, &quot;BLUE&quot;, or null if affects both
  affectedTeamId  String?       // Optional reference to specific team
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model AudienceDisplay {
  id              String        @id @default(uuid())
  matchControlId  String        @unique
  matchControl    MatchControl  @relation(fields: [matchControlId], references: [id], onDelete: Cascade)
  currentState    DisplayState  @default(STANDBY)
  customMessage   String?
  customData      Json?         // Additional display data
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

// New models for flexible scoring system

model ScoreConfig {
  id                String           @id @default(uuid())
  tournamentId      String
  tournament        Tournament       @relation(fields: [tournamentId], references: [id])
  name              String           // e.g., &quot;Fire Fighting Competition 2025&quot;
  description       String?
  scoreElements     ScoreElement[]
  bonusConditions   BonusCondition[]
  penaltyConditions PenaltyCondition[]
  matchScores       MatchScore[]     // Relation to match scores using this config
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
}

model ScoreElement {
  id            String      @id @default(uuid())
  scoreConfigId String
  scoreConfig   ScoreConfig @relation(fields: [scoreConfigId], references: [id], onDelete: Cascade)
  name          String      // e.g., &quot;Dry Powder in Own Area&quot;
  code          String      // Unique identifier for this element, e.g., &quot;dry_powder_own&quot;
  description   String?
  pointsPerUnit Int         // e.g., 5 (can be negative for penalties)
  maxUnits      Int?        // Optional limit (e.g., max 10 balls)
  category      String?     // For grouping related elements
  elementType   String      // &quot;counter&quot; (numeric) or &quot;boolean&quot; (yes/no)
  displayOrder  Int         // For UI ordering
  icon          String?     // Optional icon reference
  color         String?     // Optional color for UI
  
  @@unique([scoreConfigId, code])
}

model BonusCondition {
  id            String      @id @default(uuid())
  scoreConfigId String
  scoreConfig   ScoreConfig @relation(fields: [scoreConfigId], references: [id], onDelete: Cascade)
  name          String      // e.g., &quot;5 Dry Powder Balls Bonus&quot;
  code          String      // Unique identifier, e.g., &quot;five_balls_bonus&quot;
  description   String?
  bonusPoints   Int         // e.g., 10
  condition     Json        // JSON for storing condition logic
  displayOrder  Int         // For UI ordering
  
  @@unique([scoreConfigId, code])
}

model PenaltyCondition {
  id            String      @id @default(uuid())
  scoreConfigId String
  scoreConfig   ScoreConfig @relation(fields: [scoreConfigId], references: [id], onDelete: Cascade)
  name          String      // e.g., &quot;Red Area Violation&quot;
  code          String      // Unique identifier, e.g., &quot;red_area_violation&quot;
  description   String?
  penaltyPoints Int         // e.g., -10
  condition     Json        // JSON for storing condition logic
  displayOrder  Int         // For UI ordering
  
  @@unique([scoreConfigId, code])
}

model MatchScore {
  id                String      @id @default(uuid())
  matchId           String
  match             Match       @relation(fields: [matchId], references: [id])
  allianceId        String
  alliance          Alliance    @relation(fields: [allianceId], references: [id])
  scoreConfigId     String
  scoreConfig       ScoreConfig @relation(fields: [scoreConfigId], references: [id])
  elementScores     Json        // Store counts for each ScoreElement
  bonusesEarned     String[]    // IDs of earned BonusCondition
  penaltiesIncurred String[]    // IDs of incurred PenaltyCondition
  calculationLog    Json?       // Optional detailed breakdown of score calculation
  totalScore        Int         // Calculated total
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@unique([matchId, allianceId])
}
</code></pre>
<h2 id="5-example-configuration-for-fire-fighting-competition">5. Example Configuration for Fire-Fighting Competition</h2>
<h3 id="51-scoreelements">5.1 ScoreElements</h3>
<pre><code class="language-json"><span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Dry Powder in Own Area&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;dry_powder_own&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Yellow balls placed in team&#x27;s designated area&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;pointsPerUnit&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;maxUnits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;category&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Balls&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;elementType&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;counter&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;displayOrder&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Dry Powder in Red Area&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;dry_powder_red&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Yellow balls placed in red area&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;pointsPerUnit&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;category&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Balls&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;elementType&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;counter&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;displayOrder&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Water Ball in Red Area&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;water_ball_red&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Water balls placed in red area&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;pointsPerUnit&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;category&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Balls&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;elementType&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;counter&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;displayOrder&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Dry Powder Helping Opponent&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;dry_powder_help&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Yellow balls placed in opponent&#x27;s area (after 5 in own area)&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;pointsPerUnit&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;category&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Balls&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;elementType&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;counter&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;displayOrder&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Water Ball Wrong Position&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;water_ball_wrong&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Water balls placed in incorrect positions&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;pointsPerUnit&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-3</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;category&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Penalties&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;elementType&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;counter&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;displayOrder&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Robot Returned to End Position&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;robot_returned&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Robot successfully returned to end position&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;pointsPerUnit&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;category&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Bonus&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;elementType&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;boolean&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;displayOrder&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<h3 id="52-bonusconditions">5.2 BonusConditions</h3>
<pre><code class="language-json"><span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;5 Dry Powder Balls Bonus&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;five_balls_bonus&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Bonus for placing 5 or more dry powder balls in own area&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;bonusPoints&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;condition&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;threshold&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;elementCode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;dry_powder_own&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;operator&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&gt;=&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;displayOrder&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<h3 id="53-penaltyconditions">5.3 PenaltyConditions</h3>
<pre><code class="language-json"><span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Red Area Violation&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;red_area_violation&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Penalty for placing balls in red area before unlocking it with 5 dry powder balls&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;penaltyPoints&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-10</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;condition&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;composite&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;operator&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;AND&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;conditions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;threshold&quot;</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">&quot;elementCode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;dry_powder_own&quot;</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">&quot;operator&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&lt;&quot;</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;threshold&quot;</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">&quot;elementCode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;dry_powder_red&quot;</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">&quot;operator&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&gt;&quot;</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;displayOrder&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<h2 id="6-solid-principles-implementation">6. SOLID Principles Implementation</h2>
<h3 id="61-single-responsibility-principle-srp">6.1 Single Responsibility Principle (SRP)</h3>
<ul>
<li><code>ScoreConfigService</code>: Manages score configurations</li>
<li><code>ScoreCalculationService</code>: Handles score calculation logic</li>
<li><code>MatchScoresController</code>: Manages HTTP requests for scores</li>
<li><code>ConditionEvaluatorFactory</code>: Creates appropriate condition evaluators</li>
<li>Frontend components are separated by responsibility (input, display, configuration)</li>
</ul>
<h3 id="62-openclosed-principle-ocp">6.2 Open/Closed Principle (OCP)</h3>
<ul>
<li>The scoring system is open for extension (new competition types) without modification</li>
<li>New score elements, bonuses, or penalties can be added without changing code</li>
<li>Strategy pattern for condition evaluation allows adding new condition types</li>
</ul>
<h3 id="63-liskov-substitution-principle-lsp">6.3 Liskov Substitution Principle (LSP)</h3>
<ul>
<li>All score element types (counter, boolean) can be used interchangeably in the UI</li>
<li>Condition types (threshold, composite) follow consistent interfaces</li>
<li>All condition evaluators implement the <code>ConditionEvaluator</code> interface</li>
</ul>
<h3 id="64-interface-segregation-principle-isp">6.4 Interface Segregation Principle (ISP)</h3>
<ul>
<li>DTOs are specific to their use cases</li>
<li>Frontend components accept only the props they need</li>
<li>Clear interfaces for condition evaluation</li>
</ul>
<h3 id="65-dependency-inversion-principle-dip">6.5 Dependency Inversion Principle (DIP)</h3>
<ul>
<li>Services depend on abstractions (interfaces) rather than concrete implementations</li>
<li>Dependency injection is used throughout the NestJS backend</li>
<li>Frontend components receive dependencies via props</li>
</ul>
<h2 id="7-implementation-steps">7. Implementation Steps</h2>
<ol>
<li>
<p><strong>Database Schema Updates</strong>:</p>
<ul>
<li>Add the new models to the Prisma schema</li>
<li>Run migrations</li>
</ul>
</li>
<li>
<p><strong>Backend Implementation</strong>:</p>
<ul>
<li>Create DTOs for score configuration and submission</li>
<li>Implement services for score configuration and calculation</li>
<li>Add controllers for managing score configurations and submitting scores</li>
</ul>
</li>
<li>
<p><strong>Frontend Implementation</strong>:</p>
<ul>
<li>Create reusable components for score input and display</li>
<li>Implement TanStack Query hooks for data fetching and mutation</li>
<li>Update admin UI for creating and managing score configurations</li>
<li>Update referee UI for score input</li>
<li>Update audience display for showing scores</li>
</ul>
</li>
<li>
<p><strong>Testing</strong>:</p>
<ul>
<li>Unit tests for score calculation logic</li>
<li>Integration tests for API endpoints</li>
<li>End-to-end tests for the complete scoring workflow</li>
</ul>
</li>
</ol>
<h2 id="8-conclusion">8. Conclusion</h2>
<p>This flexible scoring system design allows for:</p>
<ol>
<li><strong>Adaptability</strong>: Can handle virtually any scoring system through configuration</li>
<li><strong>Maintainability</strong>: Clear separation of concerns following SOLID principles</li>
<li><strong>User Experience</strong>: Dynamic UI generation based on configuration</li>
<li><strong>Future-Proofing</strong>: New competition types can be added without code changes</li>
</ol>
<p>The fire-fighting competition scoring rules can be fully implemented using this system, and it will accommodate future competition types with different scoring rules as well.</p>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>